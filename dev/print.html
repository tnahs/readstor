<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ReadStor</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="A CLI for Apple Books annotations">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="src/css/custom.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ReadStor</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://www.github.com/tnahs/readstor" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>ReadStor is a simple CLI for exporting user-generated data from Apple Books. The goal of this
project is to facilitate data-migration from Apple Books to any other platform. Currently, Apple
Books provides no simple way to do this. Exporting is possible but not ideal and often times
truncates long annotations.</p>
<p>Version <code>0.1.x</code> contained the core functionality: (1) save all annotations and notes as JSON (2)
render them via a custom (or the default) template using the <a href="https://tera.netlify.app/">Tera</a> syntax or (3) backup the
current Apple Books databases.</p>
<p>Note that this repository is a heavy work-in-progress and things are bound to change.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="commands"><a class="header" href="#commands">Commands</a></h1>
<h2 id="render"><a class="header" href="#render"><code>render</code></a></h2>
<p>Render data via templates.</p>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="intro//templates/index.html">Templates</a> for a full guide on creating
templates.</p>
</blockquote>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="intro//intro/options/preprocess.html">Pre-process</a>, <a href="intro//intro/options/postprocess.html">Post-process</a> and
<a href="intro//intro/options/render.html">Render</a> options for available options.</p>
</blockquote>
<h2 id="export"><a class="header" href="#export"><code>export</code></a></h2>
<p>Export data as JSON.</p>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="intro//intro/options/preprocess.html">Pre-process</a> options for available options.</p>
</blockquote>
<p>Outputs using the following structure:</p>
<pre><code class="language-plaintext">[ouput-directory]
 ├── [author-title]
 │    ├── book.json
 │    └── annotations.json
 │
 ├── [author-title]
 │    └── ...
 └── ...
</code></pre>
<p>Example output structure:</p>
<pre><code class="language-plaintext">[ouput-directory]
 ├── Krishnamurti - Think on These Things
 │   ├── annotations.json
 │   └── book.json
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"
 │   ├── annotations.json
 │   └── book.json
 └── Robert Henri - The Art Spirit
     ├── annotations.json
     └── book.json
</code></pre>
<p>Example <code>book.json</code>:</p>
<pre><code class="language-json">{
  "title": "The Art Spirit",
  "author": "Robert Henri",
  "tags": [],
  "metadata": {
    "id": "1969AF0ECA8AE4965029A34316813924",
    "last_opened": "2021-11-02T18:27:04.781938076Z"
  },
  "slugs": {
    "title": "the-art-spirit",
    "author": "robert-henri"
  }
}
</code></pre>
<p>Example <code>annotations.json</code>:</p>
<pre><code class="language-json">[
  {
    "body": "We are not here to do what has already been done.",
    "style": "purple",
    "notes": "",
    "tags": [],
    "metadata": {
      "id": "C932CE69-8584-4555-834C-797DF84E6825",
      "book_id": "1969AF0ECA8AE4965029A34316813924",
      "created": "2021-11-02T18:12:50.826642036Z",
      "modified": "2021-11-02T18:12:51.831905841Z",
      "location": "6.18.4.2.20.2.1:0",
      "epubcfi": "epubcfi(/6/18[Part09_Split0]!/4/2/20/2/1,:0,:49)",
      "slugs": {
        "created": "2021-11-02-181250",
        "modified": "2021-11-02-181250"
      }
    }
  },
  {
    "body": "The object of painting a picture...",
    "style": "yellow",
    "notes": "",
    "tags": ["#artist", "#being"],
    "metadata": {
      "id": "3FCC630A-55E6-4D6F-8E8F-DAD7C4E20A1C",
      "book_id": "1969AF0ECA8AE4965029A34316813924",
      "created": "2021-11-02T18:13:25.905355930Z",
      "modified": "2021-11-02T18:14:12.444134950Z",
      "location": "6.24.4.2.296.2.1:0",
      "epubcfi": "epubcfi(/6/24[Part09_Split3]!/4/2/296/2,/1:0,/7:257)",
      "slugs": {
        "created": "2021-11-02-181325",
        "modified": "2021-11-02-181325"
      }
    }
  },
  {
    "body": "Of course it is not easy to go one’s road...",
    "style": "blue",
    "notes": "",
    "tags": [],
    "metadata": {
      "id": "9D1B71B1-895C-446F-A03F-50C01146F532",
      "book_id": "1969AF0ECA8AE4965029A34316813924",
      "created": "2021-11-02T18:04:45.184863090Z",
      "modified": "2021-11-02T18:12:30.355533123Z",
      "location": "6.26.4.2.446.2.1:0",
      "epubcfi": "epubcfi(/6/26[Part09_Split4]!/4/2/446/2/1,:0,:679)",
      "slugs": {
        "created": "2021-11-02-180445",
        "modified": "2021-11-02-180445"
      }
    }
  },
  {
    "body": "Do not let the fact that things are not made for you...",
    "style": "green",
    "notes": "",
    "tags": ["#inspiration"],
    "metadata": {
      "id": "4620564A-0B64-4099-B5D6-6C9116A03AFF",
      "book_id": "1969AF0ECA8AE4965029A34316813924",
      "created": "2021-11-02T18:15:10.700510978Z",
      "modified": "2021-11-02T18:15:20.879488945Z",
      "location": "6.26.4.2.636.2.1:0",
      "epubcfi": "epubcfi(/6/26[Part09_Split4]!/4/2/636/2/1,:0,:166)",
      "slugs": {
        "created": "2021-11-02-181510",
        "modified": "2021-11-02-181510"
      }
    }
  }
]
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> This <code>export</code> was run with the <a href="intro//intro/options/preprocess.html#--extract-tags"><code>--extract-tags</code></a>
option.</p>
</blockquote>
<h2 id="backup"><a class="header" href="#backup"><code>backup</code></a></h2>
<p>Back-up macOS's Apple Books databases.</p>
<p>Outputs using the following structure:</p>
<pre><code class="language-plaintext">[ouput-directory]
 └── [YYYY-MM-DD-HHMMSS-VERSION]
      ├── AEAnnotation
      │   ├── AEAnnotation*.sqlite
      │   └── ...
      └── BKLibrary
          ├── BKLibrary*.sqlite
          └── ...
</code></pre>
<p>Example output:</p>
<pre><code class="language-plaintext">[ouput-directory]
 └── 2022-10-09-152506-v4.4-5177
     ├── AEAnnotation
     │   ├── AEAnnotation_v10312011_1727_local.sqlite
     │   ├── AEAnnotation_v10312011_1727_local.sqlite-shm
     │   └── AEAnnotation_v10312011_1727_local.sqlite-wal
     └── BKLibrary
         ├── BKLibrary-1-091020131601.sqlite
         ├── BKLibrary-1-091020131601.sqlite-shm
         └── BKLibrary-1-091020131601.sqlite-wal
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="options"><a class="header" href="#options">Options</a></h1>
<p>Each of the three currently available <a href="intro/options//intro/commands.html">Commands</a> has its own pipeline for processing Apple
Books' data before writing it to disk. And by extension, each pipeline has its own set of applicable
options.</p>
<p>The pipelines and options for these three <a href="intro/options//intro/commands.html">Commands</a> are as follows:</p>
<pre><code class="language-plaintext">╭─────────╮           Export Pipeline
│ Global* │          ╭────────╮ ╭─────────────╮ ╔════════╗
╰────┬────╯        ┌─┤ Filter ├─┤ Pre-process ├─╢ export ╟────────────────────┐
     │             │ ╰────────╯ ╰─────────────╯ ╚════════╝                    │
     │             │                                                          │
     │             │                                                          │
     │             │  Render Pipeline                                         │
     │             │ ╭───────────╮                                            │
     │             │ │ Templates ├──────────────┐                             │
     │             │ ╰───────────╯              │                             │
     │ ┌╌╌╌╌╌╌╌╌╌┐ │ ╭────────╮ ╭─────────────╮ │ ╔════════╗ ╭──────────────╮ │ ┌╌╌╌╌╌╌╌┐
     █─┤ Extract ├─┴─┤ Filter ├─┤ Pre-process ├─┴─╢ render ╟─┤ Post-process ├─┼─┤ Write │
     │ └╌╌╌╌╌╌╌╌╌┘   ╰────────╯ ╰─────────────╯   ╚════════╝ ╰──────────────╯ │ └╌╌╌╌╌╌╌┘
     │                                                                        │
     │                                                                        │
     │  Backup Pipeline                                                       │
     │ ╔════════╗                                                             │
     └─╢ backup ╟─────────────────────────────────────────────────────────────┘
       ╚════════╝
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Affects Commands</th><th>Options For</th></tr></thead><tbody>
<tr><td><a href="intro/options//intro/options/global.html">Global</a></td><td>All</td><td>-</td></tr>
<tr><td><a href="intro/options//intro/options/render.html">Render</a></td><td><code>render</code></td><td>Configuring renders.</td></tr>
<tr><td><a href="intro/options//intro/options/export.html">Export</a></td><td><code>export</code></td><td>Configuring exports.</td></tr>
<tr><td><a href="intro/options//intro/options/backup.html">Backup</a></td><td><code>backup</code></td><td>Configuring backups.</td></tr>
<tr><td><a href="intro/options//intro/options/filter.html">Filter</a></td><td><code>render</code> <code>export</code></td><td>Filtering down books/annotations.</td></tr>
<tr><td><a href="intro/options//intro/options/preprocess.html">Pre-process</a></td><td><code>render</code> <code>export</code></td><td>Processing before running Command.</td></tr>
<tr><td><a href="intro/options//intro/options/postprocess.html">Post-process</a></td><td><code>render</code></td><td>Processing after running Command.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="global"><a class="header" href="#global">Global</a></h1>
<p>The following options affect all <a href="intro/options//intro/commands.html">Commands</a>.</p>
<h2 id="--output-directory-path"><a class="header" href="#--output-directory-path"><code>--output-directory &lt;PATH&gt;</code></a></h2>
<p>Set the output directory for all <a href="intro/options//intro/commands.html">Commands</a>.</p>
<p>Default: <code>~/.readstor</code>.</p>
<h2 id="--databases-directory-path"><a class="header" href="#--databases-directory-path"><code>--databases-directory &lt;PATH&gt;</code></a></h2>
<p>Set the directory containing macOS's Apple Books databases</p>
<p>Default: <code>~/Library/Containers/com.apple.iBooksX/Data/Documents</code></p>
<p>The databases directory should contain the databases for macOS's Apple Books. These databases are:
<code>AEAnnotation*.sqlite</code> and <code>BKLibrary*.sqlite</code>. The directory should follow the following structure:</p>
<pre><code class="language-plaintext">[databases-directory]
 │
 ├── AEAnnotation
 │   ├── AEAnnotation*.sqlite
 │   └── ...
 │
 ├── BKLibrary
 │   ├── BKLibrary*.sqlite
 │   └── ...
 └── ...
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> This can be useful when running ReadStor on databases backed-up
with the <a href="intro/options//intro/commands.html#backup"><code>backup</code></a> command. Note that the <a href="intro/options//intro/commands.html#backup"><code>backup</code></a> command produces an output
structure identical to this. So backing up and extracting data would require little effort.</p>
</blockquote>
<h2 id="--plists-directory-path"><a class="header" href="#--plists-directory-path"><code>--plists-directory &lt;PATH&gt;</code></a></h2>
<p>Set the directory containing iOS's Apple Books plists</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Experimental! Extracting data from Apple Books for iOS
hasn't been tested as thoroughly as its macOS counterpart. Please submit an <a href="https://github.com/tnahs/readstor/issues">issue</a>
if you run into any.</p>
</blockquote>
<p>The plists directory should contain the <code>Books.plist</code> and <code>com.apple.ibooks-sync.plist</code>. The
directory should follow the following structure:</p>
<pre><code class="language-plaintext">[plists-directory]
 │
 ├── Books.plist
 ├── com.apple.ibooks-sync.plist
 └── ...
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="intro/options//apple-books/ios/library-location.html">iOS - Library Location</a> and
<a href="intro/options//apple-books/ios/access-library.html">iOS - Access Library</a> on how to retrieve these files.</p>
</blockquote>
<h2 id="--force"><a class="header" href="#--force"><code>--force</code></a></h2>
<p>Run even if Apple Books is currently running.</p>
<h2 id="--quiet"><a class="header" href="#--quiet"><code>--quiet</code></a></h2>
<p>Silence output messages.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="render-1"><a class="header" href="#render-1">Render</a></h1>
<p>The following options affect only the <a href="intro/options//intro/commands.html#render"><code>render</code></a> commands.</p>
<h2 id="--templates-directory-path"><a class="header" href="#--templates-directory-path"><code>--templates-directory &lt;PATH&gt;</code></a></h2>
<p>Set a custom templates directory.</p>
<blockquote>
<p><i class="fa fa-info-circle"></i> See the default <a href="https://github.com/tnahs/readstor/tree/main/templates">templates</a> for fully working
examples.</p>
</blockquote>
<h2 id="--template-group-group"><a class="header" href="#--template-group-group"><code>--template-group &lt;GROUP&gt;</code></a></h2>
<p>Render specified <a href="intro/options//templates/configuration/template-groups.html">Template Groups</a>.</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Passing non-existent <a href="intro/options//templates/configuration/template-groups.html">Template Groups</a>
will return an error.</p>
</blockquote>
<p>Multiple <a href="intro/options//templates/configuration/template-groups.html">Template Groups</a> can be passed using the following syntax.</p>
<pre><code class="language-bash">readstor \
    # ...
    --template-group basic
    --template-group using-backlinks
    # ..
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="export-1"><a class="header" href="#export-1">Export</a></h1>
<p>The following options affect only the <a href="intro/options//intro/commands.html#export"><code>export</code></a> commands.</p>
<h2 id="--directory-template-template"><a class="header" href="#--directory-template-template"><code>--directory-template &lt;TEMPLATE&gt;</code></a></h2>
<p>Set the output directory template.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Context</td><td><a href="intro/options//templates/context-reference/book.html"><code>book</code></a></td></tr>
<tr><td>Default</td><td><code>{{ book.author }} - {{ book.title }}</code></td></tr>
<tr><td>Example</td><td><code>Robert Henri - The Art Spirit</code></td></tr>
</tbody></table>
</div>
<p>For example, using the default template, the non-rendered ouput structure would look like the
following:</p>
<pre><code class="language-plaintext">[ouput-directory]
 ├── {{ book.author }} - {{ book.title }}
 │    ├── book.json
 │    └── annotations.json
 │
 ├── {{ book.author }} - {{ book.title }}
 │    └── ...
 └── ...
</code></pre>
<p>And when rendered, the ouput structure would result in the following:</p>
<pre><code class="language-plaintext">[ouput-directory]
 ├── Krishnamurti - Think on These Things
 │   ├── annotations.json
 │   └── book.json
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"
 │   ├── annotations.json
 │   └── book.json
 └── Robert Henri - The Art Spirit
     ├── annotations.json
     └── book.json
</code></pre>
<h2 id="--overwrite-existing"><a class="header" href="#--overwrite-existing"><code>--overwrite-existing</code></a></h2>
<p>Overwrite existing files.</p>
<p>By default, exising files are skipped.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backup-1"><a class="header" href="#backup-1">Backup</a></h1>
<p>The following options affect only the <a href="intro/options//intro/commands.html#backup"><code>backup</code></a> commands.</p>
<h2 id="--directory-template-template-1"><a class="header" href="#--directory-template-template-1"><code>--directory-template &lt;TEMPLATE&gt;</code></a></h2>
<p>Set the output directory template</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Context</td><td><a href="intro/options/backup.html#backup-context">Backup Context</a></td></tr>
<tr><td>Default</td><td><code>{{ now | date(format='%Y-%m-%d-%H%M%S') }}-{{ version }}</code></td></tr>
<tr><td>Example Output</td><td><code>1970-01-01-120000-v0.1-0000</code></td></tr>
</tbody></table>
</div>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Note that an escaping backslash <code>\</code> was required to
nest a pipe <code>|</code> inside a markdown table. In other words, the default value does not contain
a backslash.</p>
</blockquote>
<p>For example, using the default template, the non-rendered ouput structure would
look like the following:</p>
<pre><code class="language-plaintext">[ouput-directory]
 └── {{ now | date(format='%Y-%m-%d-%H%M%S') }}-{{ version }}
      ├── AEAnnotation
      │   ├── AEAnnotation*.sqlite
      │   └── ...
      └── BKLibrary
          ├── BKLibrary*.sqlite
          └── ...
</code></pre>
<p>And when rendered, the ouput structure would result in the following:</p>
<pre><code class="language-plaintext">[ouput-directory]
 └── 2022-10-09-152506-v4.4-5177
     ├── AEAnnotation
     │   ├── AEAnnotation_v10312011_1727_local.sqlite
     │   ├── AEAnnotation_v10312011_1727_local.sqlite-shm
     │   └── AEAnnotation_v10312011_1727_local.sqlite-wal
     └── BKLibrary
         ├── BKLibrary-1-091020131601.sqlite
         ├── BKLibrary-1-091020131601.sqlite-shm
         └── BKLibrary-1-091020131601.sqlite-wal
</code></pre>
<h3 id="backup-context"><a class="header" href="#backup-context">Backup Context</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Attribute</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>now</code></td><td>datetime</td><td>the current datetime</td></tr>
<tr><td><code>version</code></td><td>string</td><td>the current version of Apple Books for macOS</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="filter"><a class="header" href="#filter">Filter</a></h1>
<p>The following options affect only the <a href="intro/options//intro/commands.html#render"><code>render</code></a> and <a href="intro/options//intro/commands.html#export"><code>export</code></a> commands.</p>
<h2 id="--filter-opfieldquery"><a class="header" href="#--filter-opfieldquery"><code>--filter &lt;[OP]{FIELD}:{QUERY}&gt;</code></a></h2>
<p>Filter books/annotations before outputting.</p>
<p>Filtering allows you to specify, to a certain degree, which books and/or annotations to output.
Currently, this is available for the <a href="intro/options//intro/commands.html#export"><code>export</code></a> and <a href="intro/options//intro/commands.html#render"><code>render</code></a> commands.</p>
<p>For example, this filter would only <a href="intro/options//intro/commands.html#render"><code>render</code></a> annotations where its respective book's title
is <em>exactly</em> <code>the art spirit</code> AND their tags <em>contain</em> the <code>#star</code> tag.</p>
<pre><code class="language-bash">readstor render \
    --extract-tags \
    --filter "=title:the art spirit" \
    --filter "tag:#star"
</code></pre>
<p>This filter would <a href="intro/options//intro/commands.html#export"><code>export</code></a> annotations where its respective book's author <em>contains</em> the
string <code>krishnamurti</code> AND their tags <em>contain either</em> <code>#star</code> or <code>#love</code>.</p>
<pre><code class="language-bash">readstor export \
    --extract-tags \
    --filter "author:krishnmurti" \
    --filter "?tag:#star #love"
</code></pre>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Note that filters are case-insensitive.</p>
</blockquote>
<h3 id="filter-results"><a class="header" href="#filter-results">Filter Results</a></h3>
<p>After all the filters are run, a confirmation prompt is shown with a brief summary of the filtered
down books/annotations.</p>
<pre><code class="language-bash">readstor render \
    --extract-tags \
    --filter "=title:the art spirit" \
    --filter "tag:#star"
...
   ----------------------------------------------------------------
   Found 9 annotations from 2 books:
    • Think on These Things by Krishnamurti
    • The Art Spirit by Robert Henri
   ----------------------------------------------------------------
   Continue? [y/N]: █
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> This prompt can be auto-confirmed by passing the
<a href="intro/options/filter.html#--auto-confirm-filter"><code>--auto-confirm-filter</code></a> flag.</p>
</blockquote>
<h3 id="filter-syntax"><a class="header" href="#filter-syntax">Filter Syntax</a></h3>
<p>A filter consists of three parts: an optional <a href="intro/options/filter.html#operator"><code>operator</code></a>, a <a href="intro/options/filter.html#field"><code>field</code></a> and a
<a href="intro/options/filter.html#query"><code>query</code></a>. The syntax structure is as follows:</p>
<pre><code class="language-plaintext">[operator]{field}:{query}
</code></pre>
<p>For example, breaking down the command from above:</p>
<pre><code class="language-plaintext">readstor render \
    --extract-tags \
    --filter "=title:the art spirit" \
              │└──┬┘ └───────────┬┘
              │   │              │
              │   │              └────────── query: the art spirit
              │   └───────────────────────── field: title
              └────────────────────────── operator: = (exact)
    --filter "tag:#star"
              └┬┘ └──┬┘
               │     │
               │     └────────────────────── query: #star
               └──────────────────────────── field: tag
                                operator (default): ? (any)
</code></pre>
<h3 id="operator"><a class="header" href="#operator">Operator</a></h3>
<p>The <code>operator</code> token determines how matching will be handled against the <code>query</code>.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>operator</code></td></tr>
<tr><td>Description</td><td>The match operation to use when filtering.</td></tr>
<tr><td>Valid Values</td><td><code>?</code>(any) <code>*</code> (all) <code>=</code> (exact)</td></tr>
<tr><td>Required</td><td>No</td></tr>
<tr><td>Default</td><td><code>?</code> (any)</td></tr>
</tbody></table>
</div>
<p>When a filter is processed, the <code>query</code> is split on its spaces to create its component queries. For
example, the input string <code>the art sprit</code> turns into three parts: <code>the</code>, <code>art</code> and <code>spirit</code>, and
depending on the <code>operator</code> these three parts are handled differently in order to determine if an
annotation is filtered out or not.</p>
<div class="table-wrapper"><table><thead><tr><th>Operator</th><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td><code>?</code></td><td>Any</td><td>Matches if <em>any</em> part of the split query is a match.</td></tr>
<tr><td><code>*</code></td><td>All</td><td>Matches if <em>all</em> parts of the split query are a match.</td></tr>
<tr><td><code>=</code></td><td>Exact</td><td>Matches if the original unsplit query is an <em>exact</em> match.</td></tr>
</tbody></table>
</div>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Note that when searching for an exact match in the <code>tags</code>
field i.e. <code>=tags:[query]</code>, the query remains split and the set of tags in the query is compared
to those in each annotation.</p>
</blockquote>
<h3 id="field"><a class="header" href="#field">Field</a></h3>
<p>The <code>field</code> token determines which field to run the filter on.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>field</code></td></tr>
<tr><td>Description</td><td>The field to use for filtering.</td></tr>
<tr><td>Valid Values</td><td><code>title</code> <code>author</code> <code>tags</code></td></tr>
<tr><td>Required</td><td>Yes</td></tr>
<tr><td>Default</td><td>-</td></tr>
</tbody></table>
</div>
<p>Currently, only three fields are supported:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Searches</th><th>Description</th></tr></thead><tbody>
<tr><td><code>title</code></td><td>books</td><td>The title of the book.</td></tr>
<tr><td><code>author</code></td><td>books</td><td>The author of the book.</td></tr>
<tr><td><code>tags</code></td><td>annotations</td><td>The annotation's <code>#tags</code>.</td></tr>
</tbody></table>
</div>
<h3 id="query"><a class="header" href="#query">Query</a></h3>
<p>The <code>query</code> string determines what will be searched in the specified <code>field</code>. A <code>query</code> is a space
delineated set of words where each word can potentially be a separate search term depending on the
specified <a href="intro/options/filter.html#operator"><code>operator</code></a>.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>query</code></td></tr>
<tr><td>Description</td><td>A space delineated query string.</td></tr>
<tr><td>Valid Values</td><td>Any</td></tr>
<tr><td>Required</td><td>Yes</td></tr>
<tr><td>Default</td><td>-</td></tr>
</tbody></table>
</div>
<h2 id="--auto-confirm-filter"><a class="header" href="#--auto-confirm-filter"><code>--auto-confirm-filter</code></a></h2>
<p>Auto-confirm <a href="intro/options/filter.html#filter-results">Filter Results</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pre-process"><a class="header" href="#pre-process">Pre-process</a></h1>
<p>The following options affect only the <a href="intro/options//intro/commands.html#render"><code>render</code></a> and <a href="intro/options//intro/commands.html#export"><code>export</code></a> commands.</p>
<h2 id="--extract-tags"><a class="header" href="#--extract-tags"><code>--extract-tags</code></a></h2>
<p>Extract <code>#tags</code> from <a href="intro/options//templates/context-reference/annotation.html"><code>annotation.notes</code></a>.</p>
<p>All matches are removed from <a href="intro/options//templates/context-reference/annotation.html"><code>annotation.notes</code></a> and placed into
<a href="intro/options//templates/context-reference/annotation.html"><code>annotation.tags</code></a>.</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Tags <em>must</em> start with a hash symbol <code>#</code> followed by a
letter <code>[a-zA-Z]</code>.</p>
</blockquote>
<h2 id="--normalize-whitespace"><a class="header" href="#--normalize-whitespace"><code>--normalize-whitespace</code></a></h2>
<p>Normalize whitespace in <a href="intro/options//templates/context-reference/annotation.html"><code>annotation.body</code></a>.</p>
<p>Trims whitespace and replaces all line-breaks with two consecutive line-breaks: <code>\n\n</code>.</p>
<h2 id="--ascii-all"><a class="header" href="#--ascii-all"><code>--ascii-all</code></a></h2>
<p>Convert all Unicode characters to ASCII.</p>
<p>All Unicode characters found in <a href="intro/options//templates/context-reference/book.html"><code>book.title</code></a>, <a href="intro/options//templates/context-reference/book.html"><code>book.author</code></a> and
<a href="intro/options//templates/context-reference/annotation.html"><code>annotation.body</code></a> are converted to ASCII.</p>
<h2 id="--ascii-symbols"><a class="header" href="#--ascii-symbols"><code>--ascii-symbols</code></a></h2>
<p>Convert "smart" Unicode symbols to ASCII.</p>
<p>"Smart" Unicode symbols found in <a href="intro/options//templates/context-reference/book.html"><code>book.title</code></a>, <a href="intro/options//templates/context-reference/book.html"><code>book.author</code></a> and
<a href="intro/options//templates/context-reference/annotation.html"><code>annotation.body</code></a> are converted to ASCII.</p>
<div class="table-wrapper"><table><thead><tr><th>Character</th><th style="text-align: center">Unicode</th><th style="text-align: center">Unicode Number</th><th style="text-align: center">ASCII</th></tr></thead><tbody>
<tr><td>Left Single Quotation Mark</td><td style="text-align: center">‘</td><td style="text-align: center">U+2018</td><td style="text-align: center">'</td></tr>
<tr><td>Right Single Quotation Mark</td><td style="text-align: center">’</td><td style="text-align: center">U+2019</td><td style="text-align: center">'</td></tr>
<tr><td>Left Double Quotation Mark</td><td style="text-align: center">“</td><td style="text-align: center">U+201C</td><td style="text-align: center">"</td></tr>
<tr><td>Right Double Quotation Mark</td><td style="text-align: center">”</td><td style="text-align: center">U+201D</td><td style="text-align: center">"</td></tr>
<tr><td>Right-Pointing Double Angle Quotation Mark</td><td style="text-align: center">»</td><td style="text-align: center">U+00BB</td><td style="text-align: center">&lt;&lt;</td></tr>
<tr><td>Left-Pointing Double Angle Quotation Mark</td><td style="text-align: center">«</td><td style="text-align: center">U+00AB</td><td style="text-align: center">&gt;&gt;</td></tr>
<tr><td>Horizontal Ellipsis</td><td style="text-align: center">…</td><td style="text-align: center">U+2026</td><td style="text-align: center">...</td></tr>
<tr><td>En Dash</td><td style="text-align: center">–</td><td style="text-align: center">U+2013</td><td style="text-align: center">--</td></tr>
<tr><td>Em Dash</td><td style="text-align: center">—</td><td style="text-align: center">U+2014</td><td style="text-align: center">---</td></tr>
</tbody></table>
</div>
<p>Characters and transliterations taken from:</p>
<ul>
<li><a href="https://daringfireball.net/projects/smartypants/">Daring Fireball - SmartyPants</a></li>
<li><a href="https://python-markdown.github.io/extensions/smarty/">Python-Markdown - SmartyPants</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="post-process"><a class="header" href="#post-process">Post-process</a></h1>
<p>The following options affect only the <a href="intro/options//intro/commands.html#render"><code>render</code></a> command.</p>
<h2 id="--trim-blocks"><a class="header" href="#--trim-blocks"><code>--trim-blocks</code></a></h2>
<p>Trim any blocks left after rendering.</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Currently, this is a <em>very</em> naive implementation that
mimics what <a href="https://docs.rs/tera/latest/tera/"><code>tera</code></a> might do if/when it adds <a href="https://github.com/Keats/tera/issues/637"><code>trim_blocks</code></a>. It is by no
means smart and will just normalize whitespace regardless of what the template requested.</p>
</blockquote>
<h2 id="--wrap-text-width"><a class="header" href="#--wrap-text-width"><code>--wrap-text &lt;WIDTH&gt;</code></a></h2>
<p>Wrap text to a maximum character width.</p>
<p>Maximum line length is not guaranteed as long words are not broken if their length exceeds the
maximum. Hyphenation is not used, however, existing hyphen can be split on to insert a line-break.</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> This will naively wrap all the text inside a rendered
file regardless its structure. Use with caution! Extremely low values may cause unexpected
results. Values above <code>80</code> or so are recommended.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="templates"><a class="header" href="#templates">Templates</a></h1>
<p>ReadStor's most powerful feature is the templating interface it provides for Apple Books. Templates
can be designed to output almost any kind of text-based file format including: Markdown, HTML, CSV.
PDFs are possible as well but would require an extra step to convert an HTML file to the final PDF.</p>
<blockquote>
<p><i class="fa fa-info-circle"></i> See the default <a href="https://github.com/tnahs/readstor/tree/main/templates">templates</a> for fully working
examples.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="an-example-template"><a class="header" href="#an-example-template">An Example Template</a></h1>
<p>The following is an example template along with its expected output and output structure. In fact,
it's almost identical to the default template that comes with ReadStor.</p>
<h2 id="template-syntax"><a class="header" href="#template-syntax">Template Syntax</a></h2>
<p><a href="https://tera.netlify.app/">Tera</a>, a Jinja-flavored templating language, provides a rich set of tools for building a wide
range of template complexities. The following is a brief intro to the syntax.</p>
<p>Values can be accessed by placing the desired attribute between double curly-braces:</p>
<pre><code class="language-jinja2">{{ book.author }}
</code></pre>
<p>A list of items can be iterated over using a <code>for</code> loop:</p>
<pre><code class="language-jinja2">{% for annotation in annotations %} ... {% endfor %}
</code></pre>
<p>Conditional behavior can be achieved by using <code>if</code>/<code>else</code> statements:</p>
<pre><code class="language-jinja2">{% if annotation.notes %}notes: {{ annotation.notes }}{% endif %}
</code></pre>
<p>Values can be modified with <code>filters</code>. Here, a list of tags is concatenated with
a space as a delimiter.</p>
<pre><code class="language-jinja2">{{ annotation.tags | join(sep=" ") }}
</code></pre>
<p>And finally comments can be added like so:</p>
<pre><code class="language-jinja2">{# Hi! I'm a comment! #}
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> See Tera's <a href="https://tera.netlify.app/docs/">documentation</a> to learn more
about these and more advanced features, including template <a href="https://tera.netlify.app/docs/#inheritance">inheritance</a>, the
<a href="https://tera.netlify.app/docs/#include">include</a> tag, <a href="https://tera.netlify.app/docs/#macros">macros</a> and the full list of available
<a href="https://tera.netlify.app/docs/#built-in-filters">filters</a>.</p>
</blockquote>
<h2 id="template"><a class="header" href="#template">Template</a></h2>
<p>Templates consist of two main sections, the configuration block written in YAML (and some
<a href="https://tera.netlify.app/">Tera</a>) and the template body written in <a href="https://tera.netlify.app/">Tera</a>.</p>
<p>The configuration for this example template describes that this template, grouped under the name
<code>my-vault</code>, will render a single file for each book and place them all directly into the output
directory. Each output filename will follow the pattern of <code>Author - Title.md</code>.</p>
<pre><code class="language-plaintext">&lt;!-- readstor
group: my-vault
context: book
structure: flat
extension: md
names:
  book: "{{ book.author }} - {{ book.title }}"
--&gt;

---
title: {{ book.title }}
author: {{ book.author }}
last-opened: {{ book.metadata.last_opened | date(format="%Y-%m-%dT%H:%M") }}
---

# {{ book.author }} - {{ book.title }}

{% for annotation in annotations -%}

---

{{ annotation.body }}

{% if annotation.notes %}notes: {{ annotation.notes }}{% endif -%}
{%- if annotation.tags %}tags: {{ annotation.tags | join(sep=" ") }}{% endif %}

{% endfor %}
</code></pre>
<h2 id="output-structure"><a class="header" href="#output-structure">Output Structure</a></h2>
<p>The output structure is primarily determined by the <code>structure</code> and <code>context</code> keys. With the
<code>structure</code> set to <code>flat</code> all the output files will be placed inside the
<a href="templates//intro/options/global.html#--output-directory-path">output directory</a> with no structure. With the <code>context</code> set to <code>book</code>, a
single file will be created for each book and, if the template body requests, will contain all its
respective annotations. See <a href="templates//templates/configuration/context-modes.html">Context Modes</a> and <a href="templates//templates/configuration/structure-modes.html">Structure Modes</a>
for more information.</p>
<pre><code class="language-plaintext">[output-directory]
 ├── Krishnamurti - Think on These Things.md
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
 └── Robert Henri - The Art Spirit.md
</code></pre>
<h2 id="output-rendered-file"><a class="header" href="#output-rendered-file">Output Rendered File</a></h2>
<h3 id="krishnamurti---think-on-these-thingsmd"><a class="header" href="#krishnamurti---think-on-these-thingsmd"><code>Krishnamurti - Think on These Things.md</code></a></h3>
<pre><code class="language-markdown">---
title: Think on These Things
author: Krishnamurti
last-opened: 2021-11-02T18:30
---

# Krishnamurti - Think on These Things

---

Do you know what intelligence is? It is the capacity, surely, to think freely,
without fear, without a formula, so that you begin to discover for yourself what
is real, what is true; but if you are frightened you will never be intelligent.
Any form of ambition, spiritual or mundane, breeds anxiety, fear; therefore
ambition does not help to bring about a mind that is clear, simple, direct, and
hence intelligent.

tags: #education #intelligence #ambition #fear

---

To find out is not to come to a conclusion. I don’t know if you see the
difference. The moment you come to a conclusion as to what intelligence is, you
cease to be intelligent. That is what most of the older people have done: they
have come to conclusions. Therefore they have ceased to be intelligent. So you
have found out one thing right off: that an intelligent mind is one which is
constantly learning, never concluding.

tags: #learning #intelligence

---

The deeper the mind penetrates its own thought processes, the more clearly it
understands that all forms of thinking are conditioned; therefore the mind is
spontaneously very still—which does not mean that it is asleep. On the contrary,
the mind is then extraordinarily alert, no longer being drugged by mantrams, by
the repetition of words, or shaped by discipline. This state of silent alertness
is also part of awareness; and if you go into it still more deeply you will find
that there is no division between the person who is aware and the object of
which he is aware.

tags: #thinking
</code></pre>
<h3 id="richard-p-feynman---surely-youre-joking-mr-feynmanmd"><a class="header" href="#richard-p-feynman---surely-youre-joking-mr-feynmanmd"><code>Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md</code></a></h3>
<pre><code class="language-markdown">---
title: "Surely You're Joking, Mr. Feynman!"
author: Richard P. Feynman
last-opened: 2021-11-02T18:27
---

# Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"

---

After the dinner we went off into another room, where there were different
conversations going on. There was a Princess Somebody of Denmark sitting at a
table with a number of people around her, and I saw an empty chair at their
table and sat down.

She turned to me and said, “Oh! You’re one of the Nobel-Prize-winners. In what
field did you do your work?”

“In physics,” I said.

“Oh. Well, nobody knows anything about that, so I guess we can’t talk about it.”

“On the contrary,” I answered. “It’s because somebody knows something about it
that we can’t talk about physics. It’s the things that nobody knows anything
about that we can discuss. We can talk about the weather; we can talk about
social problems; we can talk about psychology; we can talk about international
finance—gold transfers we can’t talk about, because those are understood—so it’s
the subject that nobody knows anything about that we can all talk about!”

I don’t know how they do it. There’s a way of forming ice on the surface of the
face, and she did it! She turned to talk to somebody else.
</code></pre>
<h3 id="robert-henri---the-art-spiritmd"><a class="header" href="#robert-henri---the-art-spiritmd"><code>Robert Henri - The Art Spirit.md</code></a></h3>
<pre><code class="language-plaintext">---
title: The Art Spirit
author: Robert Henri
last-opened: 2021-11-02T18:27
---

# Robert Henri - The Art Spirit

---

We are not here to do what has already been done.

---

The object of painting a picture is not to make a picture—however unreasonable
this may sound. The picture, if a picture results, is a by-product and may be
useful, valuable, interesting as a sign of what has past. The object, which is
back of every true work of art, is the attainment of a state of being, a state
of high functioning, a more than ordinary moment of existence. In such moments
activity is inevitable, and whether this activity is with brush, pen, chisel, or
tongue, its result is but a by-product of the state, a trace, the footprint of
the state.

tags: #artist #being

---

Of course it is not easy to go one’s road. Because of our education we
continually get off our track, but the fight is a good one and there is joy in
it if there is any success at all. After all, the goal is not making art. It is
living a life. Those who live their lives will leave the stuff that is really
art. Art is a result. It is the trace of those who have led their lives. It is
interesting to us because we read the struggle and the degree of success the man
made in his struggle to live. The great question is: “What is worth while?” The
majority of people have failed to ask themselves seriously enough, and have
failed to try seriously enough to answer this question.

---

Do not let the fact that things are not made for you, that conditions are not as
they should be, stop you. Go on anyway. Everything depends on those who go on
anyway.

tags: #inspiration
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>A template's configuration describes both what the template expects to render and how the output
structure and naming should be. Every template must start with a configuration block.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The configuration starts off as a basic HTML comment tag...</p>
<pre><code class="language-markdown">&lt;!-- --&gt;
</code></pre>
<p>... with the word <code>readstor</code>...</p>
<pre><code class="language-markdown">&lt;!-- readstor --&gt;
</code></pre>
<p>...and a new line.</p>
<pre><code class="language-markdown">&lt;!-- readstor

--&gt;
</code></pre>
<p>The YAML configuration is then placed inside the tag. For example:</p>
<pre><code class="language-markdown">&lt;!-- readstor
group: my-vault
context: book
structure: nested
extension: md
names:
  book: "{{ book.author }} - {{ book.title }}"
  annotation: "{{ annotation.slugs.metadata.created }}-{{ book.slugs.title }}"
  directory: "{{ book.author }} - {{ book.title }}"
--&gt;

...
</code></pre>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Note that the final rendered output file will not include
its template's configuration. Additionally, if the configuration ended with trailing line-breaks,
a single one of them is removed. This allows for some extra whitespace while working with a
template without affecting final rendered output.</p>
</blockquote>
<p>A quick rundown of each configuration key:</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody>
<tr><td><code>group</code></td><td>The <a href="templates/configuration//templates/configuration/template-groups.html">Template Group</a> name.</td></tr>
<tr><td><code>context</code></td><td>The <a href="templates/configuration//templates/configuration/context-modes.html">Context Mode</a> or what the template will render.</td></tr>
<tr><td><code>structure</code></td><td>The <a href="templates/configuration//templates/configuration/structure-modes.html">Structure Mode</a> or how the output files will be structured.</td></tr>
<tr><td><code>extension</code></td><td>The template's output <a href="templates/configuration//templates/configuration/file-extensions.html">File Extension</a>.</td></tr>
<tr><td><code>names</code></td><td>The template <a href="templates/configuration//templates/configuration/names.html">Names</a> for generating file and directory names.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="template-groups"><a class="header" href="#template-groups">Template Groups</a></h1>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>group</code></td></tr>
<tr><td>Type</td><td>string</td></tr>
<tr><td>Valid Values</td><td>any</td></tr>
<tr><td>Required</td><td><i class="fa fa-check"></i></td></tr>
<tr><td>Default</td><td>-</td></tr>
</tbody></table>
</div>
<p>Groups are used to identify multiple templates that are intended to be part of a single output.
Conversely, they also provide a way to separate unrelated templates rendered to the same output
directory. The most common use case would be when using a pair of templates where one is used to
render a book and the other to render each of its annotations separately.</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Group names are sanitized to make sure they interact well
with the file system. See <a href="templates/configuration//templates/string-sanitization.html">String Sanitization</a> for more information.</p>
</blockquote>
<p>Grouping is triggered when one or more templates are set to either the <code>flat-grouped</code> or the
<code>nested-grouped</code> <a href="templates/configuration//templates/configuration/structure-modes.html">Structure Mode</a>. The output files are placed within a directory
named after the <code>group</code>.</p>
<p>For example, if two templates share these values in their configurations:</p>
<pre><code class="language-yaml">group: my-vault
structure: flat-grouped
</code></pre>
<p>The output will be:</p>
<pre><code class="language-plaintext">[output-directory]
 ├── my-vault
 │   ├── 2021-11-02-180445-the-art-spirit.md
 │   ├── 2021-11-02-181250-the-art-spirit.md
 │   ├── 2021-11-02-181325-the-art-spirit.md
 │   ├── 2021-11-02-181510-the-art-spirit.md
 │   ├── 2021-11-02-182059-surely-youre-joking-mr-feynman.md
 │   ├── 2021-11-02-182319-think-on-these-things.md
 │   ├── 2021-11-02-182426-think-on-these-things.md
 │   ├── 2021-11-02-182543-think-on-these-things.md
 │   ├── 2021-11-02-182648-think-on-these-things.md
 │   ├── 2021-11-02-182805-think-on-these-things.md
 │   ├── Krishnamurti - Think on These Things.md
 │   ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
 │   └── Robert Henri - The Art Spirit.md
 │
 ├── [other-group]
 │    └── ...
 └── ...
</code></pre>
<p>And, if two templates share these values in their configurations:</p>
<pre><code class="language-yaml">group: my-vault
structure: nested-grouped
</code></pre>
<p>The output will be:</p>
<pre><code class="language-plaintext">[output-directory]
 ├── my-vault
 │   ├── Krishnamurti - Think on These Things
 │   │   ├── 2021-11-02-182319-think-on-these-things.md
 │   │   ├── 2021-11-02-182426-think-on-these-things.md
 │   │   ├── 2021-11-02-182543-think-on-these-things.md
 │   │   ├── 2021-11-02-182648-think-on-these-things.md
 │   │   ├── 2021-11-02-182805-think-on-these-things.md
 │   │   └── Krishnamurti - Think on These Things.md
 │   ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"
 │   │   ├── 2021-11-02-182059-surely-youre-joking-mr-feynman.md
 │   │   └── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
 │   └── Robert Henri - The Art Spirit
 │       ├── 2021-11-02-180445-the-art-spirit.md
 │       ├── 2021-11-02-181250-the-art-spirit.md
 │       ├── 2021-11-02-181325-the-art-spirit.md
 │       ├── 2021-11-02-181510-the-art-spirit.md
 │       └── Robert Henri - The Art Spirit.md`
 │
 ├── [other-group]
 │    └── ...
 └── ...
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="context-modes"><a class="header" href="#context-modes">Context Modes</a></h1>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>context</code></td></tr>
<tr><td>Type</td><td>string</td></tr>
<tr><td>Valid Values</td><td><code>book</code> <code>annotation</code></td></tr>
<tr><td>Required</td><td><i class="fa fa-check"></i></td></tr>
<tr><td>Default</td><td>-</td></tr>
</tbody></table>
</div>
<p>At render time, each template is injected with a "context", in other words, the data it will render.
ReadStor provides two different context modes: <code>book</code> and <code>annotation</code>. The context mode dictates
not just the data within the context but also changes the number of output files. See
<a href="templates/configuration/context-modes.html#a-note-on-output-structure">A Note On Output Structure</a> for more information.</p>
<h2 id="the-book-context"><a class="header" href="#the-book-context">The Book Context</a></h2>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Context Mode</td><td><code>book</code></td></tr>
<tr><td>Context Objects</td><td><a href="templates/configuration//templates/context-reference/book.html"><code>book</code></a> <a href="templates/configuration//templates/context-reference/annotation.html"><code>annotations</code></a> <a href="templates/configuration//templates/context-reference/names.html"><code>names</code></a></td></tr>
<tr><td>Output Files</td><td>=1</td></tr>
</tbody></table>
</div>
<blockquote>
<p><i class="fa fa-info-circle"></i> Note that <code>annotations</code> is plural in the <code>book</code> context.</p>
</blockquote>
<p>When selected, a single file is rendered out from a context containing the data from a single book
and its annotations. For example, represented here in YAML:</p>
<pre><code class="language-yaml">book:
  title: The Art Spirit
  author: Robert Henri
  metadata:
    id: 1969AF0ECA8AE4965029A34316813924
    last_opened: 2021-11-02T18:27:04.781938076Z
  slugs:
    title: the-art-spirit
    author: robert-henri
annotations:
  - body: We are not here to do what has already been done.
    style: purple
    notes: ""
    tags: []
    metadata:
      id: C932CE69-8584-4555-834C-797DF84E6825
      book_id: 1969AF0ECA8AE4965029A34316813924
      created: 2021-11-02T18:12:50.826642036Z
      modified: 2021-11-02T18:12:51.831905841Z
      location: 6.18.4.2.20.2.1:0
      epubcfi: epubcfi(/6/18[Part09_Split0]!/4/2/20/2/1,:0,:49)
      slugs:
        created: 2021-11-02-181250
        modified: 2021-11-02-181250
  - body: The object of painting a picture...
    style: yellow
    notes: ""
    tags:
      - "#artist"
      - "#being"
    metadata:
      id: 3FCC630A-55E6-4D6F-8E8F-DAD7C4E20A1C
      book_id: 1969AF0ECA8AE4965029A34316813924
      created: 2021-11-02T18:13:25.905355930Z
      modified: 2021-11-02T18:14:12.444134950Z
      location: 6.24.4.2.296.2.1:0
      epubcfi: epubcfi(/6/24[Part09_Split3]!/4/2/296/2,/1:0,/7:257)
      slugs:
        created: 2021-11-02-181325
        modified: 2021-11-02-181325
  # ...
names:
  book: Robert Henri - The Art Spirit.md
  annotations:
    C932CE69-8584-4555-834C-797DF84E6825: 2021-11-02-181250-the-art-spirit.md
    3FCC630A-55E6-4D6F-8E8F-DAD7C4E20A1C: 2021-11-02-181325-the-art-spirit.md
    # ...
  directory: Robert Henri - The Art Spirit
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="templates/configuration//templates/context-reference/book.html">Context Reference - Book</a> for more information.</p>
</blockquote>
<h2 id="the-annotation-context"><a class="header" href="#the-annotation-context">The Annotation Context</a></h2>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Context Mode</td><td><code>annotation</code></td></tr>
<tr><td>Context Objects</td><td><a href="templates/configuration//templates/context-reference/book.html"><code>book</code></a> <a href="templates/configuration//templates/context-reference/annotation.html"><code>annotation</code></a> <a href="templates/configuration//templates/context-reference/names.html"><code>names</code></a></td></tr>
<tr><td>Output Files</td><td>&gt;=1</td></tr>
</tbody></table>
</div>
<p>When selected, multiple files are rendered out from a context containing the data from a single
annotation and its respective book. For example, represented here in YAML:</p>
<pre><code class="language-yaml">book:
  title: The Art Spirit
  author: Robert Henri
  metadata:
    id: 1969AF0ECA8AE4965029A34316813924
    last_opened: 2021-11-02T18:27:04.781938076Z
  slugs:
    title: the-art-spirit
    author: robert-henri
annotation:
  body: We are not here to do what has already been done.
  style: purple
  notes: ""
  tags: []
  metadata:
    id: C932CE69-8584-4555-834C-797DF84E6825
    book_id: 1969AF0ECA8AE4965029A34316813924
    created: 2021-11-02T18:12:50.826642036Z
    modified: 2021-11-02T18:12:51.831905841Z
    location: 6.18.4.2.20.2.1:0
    epubcfi: epubcfi(/6/18[Part09_Split0]!/4/2/20/2/1,:0,:49)
    slugs:
      created: 2021-11-02-181250
      modified: 2021-11-02-181250
names:
  book: Robert Henri - The Art Spirit.md
  annotations:
    C932CE69-8584-4555-834C-797DF84E6825: 2021-11-02-181250-the-art-spirit.md
  directory: Robert Henri - The Art Spirit
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="templates/configuration//templates/context-reference/annotation.html">Context Reference - Annotation</a> for more
information.</p>
</blockquote>
<h2 id="a-note-on-output-structure"><a class="header" href="#a-note-on-output-structure"><i class="fa fa-exclamation-circle"></i> A Note On Output Structure</a></h2>
<p>When selecting a context mode it's important to understand how the output files will look. The
following is a quick visualization.</p>
<p>When the context mode is set to <code>book</code>, a single file for each book is rendered out from the
template. Using the following configuration keys:</p>
<pre><code class="language-yaml">context: book
structure: nested
</code></pre>
<p>The output structure is as follows:</p>
<pre><code class="language-plaintext">[output-directory]
 ├── Krishnamurti - Think on These Things
 │   └── Krishnamurti - Think on These Things.md
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"
 │   └── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
 └── Robert Henri - The Art Spirit
     └── Robert Henri - The Art Spirit.md`
</code></pre>
<p>And when the context mode is set to <code>annotation</code>, multiple files are rendered out, one for each
annotation within a book. Using the following configuration keys:</p>
<pre><code class="language-yaml">context: annotation
structure: nested
</code></pre>
<p>The output structure is as follows:</p>
<pre><code class="language-plaintext">[output-directory]
 ├── Krishnamurti - Think on These Things
 │   ├── 2021-11-02-182319-think-on-these-things.md
 │   ├── 2021-11-02-182426-think-on-these-things.md
 │   ├── 2021-11-02-182543-think-on-these-things.md
 │   ├── 2021-11-02-182648-think-on-these-things.md
 │   └── 2021-11-02-182805-think-on-these-things.md
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"
 │   └── 2021-11-02-182059-surely-youre-joking-mr-feynman.md
 └── Robert Henri - The Art Spirit
     ├── 2021-11-02-180445-the-art-spirit.md
     ├── 2021-11-02-181250-the-art-spirit.md
     ├── 2021-11-02-181325-the-art-spirit.md
     └── 2021-11-02-181510-the-art-spirit.md
</code></pre>
<p>When both templates are rendered to the same directory, we get a complete output with a book and
each of its annotations all rendered out to their own file.</p>
<pre><code class="language-plaintext">[output-directory]
 ├── Krishnamurti - Think on These Things
 │   ├── 2021-11-02-182319-think-on-these-things.md
 │   ├── 2021-11-02-182426-think-on-these-things.md
 │   ├── 2021-11-02-182543-think-on-these-things.md
 │   ├── 2021-11-02-182648-think-on-these-things.md
 │   ├── 2021-11-02-182805-think-on-these-things.md
 │   └── Krishnamurti - Think on These Things.md
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"
 │   ├── 2021-11-02-182059-surely-youre-joking-mr-feynman.md
 │   └── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
 └── Robert Henri - The Art Spirit
     ├── 2021-11-02-180445-the-art-spirit.md
     ├── 2021-11-02-181250-the-art-spirit.md
     ├── 2021-11-02-181325-the-art-spirit.md
     ├── 2021-11-02-181510-the-art-spirit.md
     └── Robert Henri - The Art Spirit.md
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="structure-modes"><a class="header" href="#structure-modes">Structure Modes</a></h1>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>ouput</code></td></tr>
<tr><td>Type</td><td>string</td></tr>
<tr><td>Valid Values</td><td><code>flat</code> <code>flat-grouped</code> <code>nested</code> <code>nested-grouped</code></td></tr>
<tr><td>Required</td><td><i class="fa fa-check"></i></td></tr>
<tr><td>Default</td><td>-</td></tr>
</tbody></table>
</div>
<p>The structure mode determines how the output directories and files are structured. ReadStor provides
four structure modes: <code>flat</code>, <code>flat-grouped</code>, <code>nested</code> and <code>nested-grouped</code>.</p>
<h2 id="flat-mode"><a class="header" href="#flat-mode">Flat Mode</a></h2>
<pre><code class="language-yaml">structure: flat
</code></pre>
<p>When selected, the template is rendered to the output directory without any structure. All the files
are placed directly within the output directory. No additional directories are created.</p>
<pre><code class="language-plaintext">[output-directory]
 ├── Krishnamurti - Think on These Things.md
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
 ├── Robert Henri - The Art Spirit.md
 └── ...
</code></pre>
<h2 id="flat--grouped-mode"><a class="header" href="#flat--grouped-mode">Flat &amp; Grouped Mode</a></h2>
<pre><code class="language-yaml">group: my-vault
structure: flat-grouped
</code></pre>
<p>When selected, the template is rendered to the output directory and placed inside a directory
named after its <code>group</code>. This is useful if multiple template groups are being rendered to the same
directory.</p>
<pre><code class="language-plaintext">[output-directory]
 └── my-vault
     ├── Krishnamurti - Think on These Things.md
     ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
     ├── Robert Henri - The Art Spirit.md
     └── ...
</code></pre>
<h2 id="nested-mode"><a class="header" href="#nested-mode">Nested Mode</a></h2>
<pre><code class="language-yaml">structure: nested
</code></pre>
<p>When selected, the template is rendered to the <a href="templates/configuration//intro/options/global.html#--output-directory-path">output directory</a> and placed
inside a directory named after the <code>names.directory</code> key. This is useful if a template group
contains multiple templates.</p>
<pre><code class="language-plaintext">[output-directory]
 ├── Krishnamurti - Think on These Things
 │   ├── 2021-11-02-182319-think-on-these-things.md
 │   ├── 2021-11-02-182426-think-on-these-things.md
 │   ├── 2021-11-02-182543-think-on-these-things.md
 │   ├── 2021-11-02-182648-think-on-these-things.md
 │   ├── 2021-11-02-182805-think-on-these-things.md
 │   └── Krishnamurti - Think on These Things.md
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"
 │   ├── 2021-11-02-182059-surely-youre-joking-mr-feynman.md
 │   └── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
 ├── Robert Henri - The Art Spirit
 │   ├── 2021-11-02-180445-the-art-spirit.md
 │   ├── 2021-11-02-181250-the-art-spirit.md
 │   ├── 2021-11-02-181325-the-art-spirit.md
 │   ├── 2021-11-02-181510-the-art-spirit.md
 │   └── Robert Henri - The Art Spirit.md`
 └── ...
</code></pre>
<h2 id="nested--grouped-mode"><a class="header" href="#nested--grouped-mode">Nested &amp; Grouped Mode</a></h2>
<pre><code class="language-yaml">group: my-vault
structure: nested-grouped
</code></pre>
<p>When selected, the template is rendered to the <a href="templates/configuration//intro/options/global.html#--output-directory-path">output directory</a> and placed
inside a directory named after its <code>group</code> and another named after the <code>names.directory</code> key. This
is useful if multiple template groups are being rendered to the same directory and if a template
group contains multiple templates.</p>
<pre><code class="language-plaintext">[output-directory]
 └── my-vault
     ├── Krishnamurti - Think on These Things
     │   ├── 2021-11-02-182319-think-on-these-things.md
     │   ├── 2021-11-02-182426-think-on-these-things.md
     │   ├── 2021-11-02-182543-think-on-these-things.md
     │   ├── 2021-11-02-182648-think-on-these-things.md
     │   ├── 2021-11-02-182805-think-on-these-things.md
     │   └── Krishnamurti - Think on These Things.md
     ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!"
     │   ├── 2021-11-02-182059-surely-youre-joking-mr-feynman.md
     │   └── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
     └── Robert Henri - The Art Spirit
         ├── 2021-11-02-180445-the-art-spirit.md
         ├── 2021-11-02-181250-the-art-spirit.md
         ├── 2021-11-02-181325-the-art-spirit.md
         ├── 2021-11-02-181510-the-art-spirit.md
         └── Robert Henri - The Art Spirit.md
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="extension"><a class="header" href="#extension">Extension</a></h1>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>extension</code></td></tr>
<tr><td>Type</td><td>string</td></tr>
<tr><td>Valid Values</td><td>any</td></tr>
<tr><td>Required</td><td><i class="fa fa-check"></i></td></tr>
<tr><td>Default</td><td>-</td></tr>
</tbody></table>
</div>
<p>Defines the template's output file extension. Note that this will be appended to all the output
filenames with the format <code>[filename].[extension]</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="names"><a class="header" href="#names">Names</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Context</th></tr></thead><tbody>
<tr><td><code>names.book</code></td><td><code>book</code></td></tr>
<tr><td><code>names.annotation</code></td><td><code>annotation</code></td></tr>
<tr><td><code>names.directory</code></td><td><code>book</code></td></tr>
</tbody></table>
</div>
<p>Output files and directory names can be customized using the same <a href="https://tera.netlify.app/">Tera</a> syntax. ReadStor will
inject a different context into each <code>names</code> during render time and set the template's output
file/directory name to the resulting string.</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> The rendered book, annotation and directory names are
sanitized to make sure they interact well with the file system. See
<a href="templates/configuration//templates/string-sanitization.html">String Sanitization</a> for more information.</p>
</blockquote>
<p>Additionally, all the rendered values from these keys are available within the template's context
under the <code>names</code> variable regardless of the current context mode. See
<a href="templates/configuration//templates/context-reference/names.html">Context Reference - Names</a> for more information.</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> Note that the template's <code>context</code> matters when setting
<code>names</code>.</p>
<p>For example, if the template's <code>context</code> is set to <code>book</code>:</p>
<pre><code class="language-yaml">group: my-vault
structure: flat
context: book # &lt;- Here!
extension: md
names:
  book: "{{ book.author }} - {{ book.title }}"
  annotation: "{{ annotation.slugs.metadata.created }}-{{ book.slugs.title }}"
</code></pre>
<p>ReadStor will generate a single file for each book and name them using the rendered result of
<code>names.book</code>. The resulting output would be:</p>
<pre><code class="language-plaintext">[output-directory]
 ├── Krishnamurti - Think on These Things.md
 ├── Richard P. Feynman - "Surely You're Joking, Mr. Feynman!".md
 ├── Robert Henri - The Art Spirit.md
 └── ...
</code></pre>
<p>However, if the <code>context</code> is changed to <code>annotation</code>:</p>
<pre><code class="language-yaml">group: my-vault
structure: flat
context: annotation # &lt;- Here!
extension: md
names:
  book: "{{ book.author }} - {{ book.title }}"
  annotation: "{{ annotation.slugs.metadata.created }}-{{ book.slugs.title }}"
</code></pre>
<p>ReadStor will now generate a single file for each annotation in each book and name them using the
rendered result of <code>names.annotation</code>. The resulting output would be:</p>
<pre><code class="language-plaintext">[output-directory]
 ├── 2021-11-02-180445-the-art-spirit.md
 ├── 2021-11-02-181250-the-art-spirit.md
 ├── 2021-11-02-181325-the-art-spirit.md
 ├── 2021-11-02-181510-the-art-spirit.md
 ├── 2021-11-02-182059-surely-youre-joking-mr-feynman.md
 ├── 2021-11-02-182319-think-on-these-things.md
 ├── 2021-11-02-182426-think-on-these-things.md
 ├── 2021-11-02-182543-think-on-these-things.md
 ├── 2021-11-02-182648-think-on-these-things.md
 ├── 2021-11-02-182805-think-on-these-things.md
 └── ...
</code></pre>
</blockquote>
<h2 id="book-names"><a class="header" href="#book-names">Book Names</a></h2>
<p>Defines the filename template to use when the parent template's <code>context</code> mode is set to <code>book</code>.
This template only has access to the <code>book</code> context when it's rendered.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>names.book</code></td></tr>
<tr><td>Type</td><td>string</td></tr>
<tr><td>Valid Values</td><td>any</td></tr>
<tr><td>Required</td><td>No</td></tr>
<tr><td>Default</td><td><code>{{ book.author }} - {{ book.title }}</code></td></tr>
</tbody></table>
</div>
<h2 id="annotation-names"><a class="header" href="#annotation-names">Annotation Names</a></h2>
<p>Defines the filename template to use when the parent template's <code>context</code> mode is set to
<code>annotation</code>. This template has access to the <code>book</code> and <code>annotation</code> context when its rendered.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>names.annotation</code></td></tr>
<tr><td>Type</td><td>string</td></tr>
<tr><td>Valid Values</td><td>any</td></tr>
<tr><td>Required</td><td>No</td></tr>
<tr><td>Default</td><td><code>{{ annotation.slugs.metadata.created }}-{{ book.slugs.title }}</code></td></tr>
</tbody></table>
</div>
<h2 id="directory-names"><a class="header" href="#directory-names">Directory Names</a></h2>
<p>Defines the directory name template to use when the parent template's <code>structure</code> mode is set to
<code>nested</code> or the <code>nested-grouped</code>. This template only has access to the <code>book</code> context when its
rendered.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Name</td><td><code>names.directory</code></td></tr>
<tr><td>Type</td><td>string</td></tr>
<tr><td>Valid Values</td><td>any</td></tr>
<tr><td>Required</td><td>No</td></tr>
<tr><td>Default</td><td><code>{{ book.author }} - {{ book.title }}</code></td></tr>
</tbody></table>
</div>
<h2 id="limitations"><a class="header" href="#limitations"><i class="fa fa-exclamation-circle"></i> Limitations</a></h2>
<p>Why does a single template have both a <code>names.book</code> and <code>names.annotation</code> key?</p>
<p>This is mainly the result of a current limitation with ReadStor. Templates that are part of
the same <code>group</code> have no relation internally. ReadStor just renders each template it finds. If
multiple templates share the same value for <code>group</code> then they end up in the same directory when the
<code>structure</code> mode is set to <code>grouped</code> or <code>nested-grouped</code>.</p>
<p>As a result of this limitation, if a template requires awareness of its <code>group</code>'s sibling names
i.e. the value defined in the <a href="templates/configuration//templates/context-reference/names.html"><code>names</code></a> field, they <em>must</em> be defined in each template. This
results in some duplication across templates. This should hopefully be resolved in future versions
of ReadStor.</p>
<blockquote>
<p><i class="fa fa-info-circle"></i> For more information on how to generate and use <code>names</code> see
<a href="templates/configuration//templates/context-reference/names.html">Context Reference - Names</a> and <a href="templates/configuration//templates/backlinks.html">Backlinks</a>.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="partial-templates"><a class="header" href="#partial-templates">Partial Templates</a></h1>
<p>When working with larger templates it can be helpful to separate them into smaller building blocks.
One way to do this is to create partial templates and <code>include</code> them in other templates.</p>
<p>Partial templates differ in two important ways from their normal template counterparts.</p>
<ol>
<li>
<p>They <em>must</em> begin with an underscore <code>_</code> as this is currently the only indicator of whether a
template is partial or not.</p>
</li>
<li>
<p>They require no configuration block as they inherit their configuration from the template that
<code>include</code>s them.</p>
</li>
</ol>
<blockquote>
<p><i class="fa fa-info-circle"></i> See the <a href="https://github.com/tnahs/readstor/tree/main/templates/using-partials">using-partials</a> templates for a fully
working example.</p>
</blockquote>
<h2 id="including-a-partial-template"><a class="header" href="#including-a-partial-template">Including a Partial Template</a></h2>
<p>Partial templates are included using the <code>include</code> tag:</p>
<pre><code class="language-jinja2">{% include "_my-partial-template.md" %}
</code></pre>
<p>Where <code>"_my-partial-template.md"</code> is a path relative to the
<a href="templates//intro/options/render.html#--templates-directory-path">templates directory</a>. Therefore, this would be pointing to a template at the
root of the <a href="templates//intro/options/render.html#--templates-directory-path">templates directory</a>. If we wanted to organize our templates
into different directories we would have to add the directory names for any directories between the
including template and the <a href="templates//intro/options/render.html#--templates-directory-path">templates directory</a>.</p>
<p>For example, with the following structure:</p>
<pre><code class="language-plaintext">[templates-directory]
 └── my-vault-templates
     ├── _annotation.md
     ├── _book.md
     └── template.md
</code></pre>
<p>We would use the following <code>include</code> tags:</p>
<pre><code class="language-jinja2">{% include "my-vault-templates/_book.jinja2" %}
{% include "my-vault-templates/_annotation.jinja2" %}
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> See the documentation for <a href="https://tera.netlify.app/">Tera</a>'s <a href="https://tera.netlify.app/docs/#include">include</a>
tag for more information on its features and limitations.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backlinks"><a class="header" href="#backlinks">Backlinks</a></h1>
<p>Generating backlinks for a Zettelkasten-like note-taking experience is relatively easy with
ReadStor. It requires two separate templates: One for rendering the book and one for rendering each
of its annotations.</p>
<blockquote>
<p><i class="fa fa-info-circle"></i> See the <a href="https://github.com/tnahs/readstor/tree/main/templates/using-backlinks">using-backlinks</a> templates for a fully
working example.</p>
</blockquote>
<h2 id="template-configuration"><a class="header" href="#template-configuration">Template Configuration</a></h2>
<p>First, let's define the configurations for our two templates. They should be <em>almost</em> identical to
one another.</p>
<ul>
<li>
<p><code>group</code> is set to the same value across the two templates. This makes sure that if we select a
grouped <a href="templates//templates/configuration/structure-modes.html">Structure Mode</a>, the templates will be rendered to the same directory.</p>
</li>
<li>
<p><code>context</code> is set to <code>book</code> for the book template and <code>annotation</code> for the annotation template.</p>
</li>
<li>
<p><code>structure</code> can be set to any of the four modes, however, <code>nested-grouped</code> feels the most
appropriate as it would place each book into its own directory and place them all under a
directory named after the value for the <code>group</code> key. See <a href="templates//templates/configuration/structure-modes.html">Structure Modes</a> for
more information.</p>
</li>
<li>
<p><code>extension</code> is set to <code>md</code> as the template will be outputting Markdown.</p>
</li>
<li>
<p><code>names</code> can be set to anything as long as the values are identical between the two templates. It
might seem odd to see the values for <code>names</code> duplicated across the two templates. Shouldn't the
book template define <code>names.book</code> and the annotation template define <code>names.annotation</code>? Ideally,
yes. This need for duplication is the result of a current <a href="templates//templates/configuration/names.html#limitations">limitation</a> of
ReadStor, therefore they <em>must</em> be identical, so the backlinks are correctly generated.</p>
</li>
</ul>
<h3 id="book-template-configuration"><a class="header" href="#book-template-configuration">Book Template Configuration</a></h3>
<pre><code class="language-yaml">group: my-vault
context: book # &lt;- The only difference!
structure: nested-grouped
extension: md
names:
  book: "{{ book.author }} - {{ book.title }}"
  annotation: "{{ annotation.slugs.metadata.created }}-{{ book.slugs.title }}"
  directory: "{{ book.author }} - {{ book.title }}"
</code></pre>
<h3 id="annotation-template-configuration"><a class="header" href="#annotation-template-configuration">Annotation Template Configuration</a></h3>
<pre><code class="language-yaml">group: my-vault
context: annotation # &lt;- The only difference!
structure: nested-grouped
extension: md
names:
  book: "{{ book.author }} - {{ book.title }}"
  annotation: "{{ annotation.slugs.metadata.created }}-{{ book.slugs.title }}"
  directory: "{{ book.author }} - {{ book.title }}"
</code></pre>
<h2 id="template-body"><a class="header" href="#template-body">Template Body</a></h2>
<p>With our configuration all set up, we can now use the <code>names</code> object, which contains all the
rendered <a href="templates//templates/context-reference/names.html">Names</a>, to link between our rendered output files.</p>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="templates//templates/context-reference/names.html">Context Reference - Names</a> for more information.</p>
</blockquote>
<h3 id="book-template-body"><a class="header" href="#book-template-body">Book Template Body</a></h3>
<p>The <code>names.annotations</code> object is a list of dictionaries, where each dictionary refers to a rendered
annotation file and contains its filename along with metadata about its respective annotation. This
allows us to link back to the annotation and sort the links based of off different criteria. In the
example below, <a href="https://tera.netlify.app/">Tera</a>'s <a href="https://tera.netlify.app/docs/#sort"><code>sort</code></a> filter is used with the <code>attribute</code> argument and
the <code>location</code> attribute.</p>
<pre><code class="language-jinja2"># {{ book.author }} - {{ book.title }}

{% for name in names.annotations | sort(attribute="location")-%}
![[{{ name.filename }}]]
{% endfor %}
</code></pre>
<p>Alternatively we can use the <code>names.directory</code> variable to access the rendered name of the parent
directory. This value is only available if the <a href="templates//templates/configuration/structure-modes.html">Structure Mode</a> is set to <code>nested</code>
or <code>nested-grouped</code>.</p>
<!-- TODO: Verify this works! -->
<pre><code class="language-jinja2"># {{ book.author }} - {{ book.title }}

{% for name in names.annotations -%}
![[{{ name.directory }}/{{ name.filename }}]]
{% endfor %}
</code></pre>
<h3 id="annotation-template-body"><a class="header" href="#annotation-template-body">Annotation Template Body</a></h3>
<p>Finally, using the <code>names.book</code> variable we're able to link back to the source book.</p>
<pre><code class="language-jinja2"># [[{{ names.book }}]]

{{ annotation.body }}

{% if annotation.notes %}notes: {{ annotation.notes }}{% endif -%}
{%- if annotation.tags %}tags: {{ annotation.tags | join(sep=" ") }}{% endif -%}
</code></pre>
<h2 id="output-structure-1"><a class="header" href="#output-structure-1">Output Structure</a></h2>
<pre><code class="language-plaintext">[output-directory]
 ├── my-vault
 │   └── Robert Henri - The Art Spirit
 │       ├── 2021-11-02-180445-the-art-spirit.md
 │       ├── 2021-11-02-181250-the-art-spirit.md
 │       ├── 2021-11-02-181325-the-art-spirit.md
 │       ├── 2021-11-02-181510-the-art-spirit.md
 │       └── Robert Henri - The Art Spirit.md
 │
 ├── [group]
 │    └── ...
 └── ...
</code></pre>
<h2 id="output-rendered-files"><a class="header" href="#output-rendered-files">Output Rendered Files</a></h2>
<p><code>Robert Henri - The Art Spirit.md</code></p>
<pre><code class="language-markdown"># Robert Henri - The Art Spirit

![[2021-11-02-180445-the-art-spirit.md]]
![[2021-11-02-181250-the-art-spirit.md]]
![[2021-11-02-181325-the-art-spirit.md]]
![[2021-11-02-181510-the-art-spirit.md]]
</code></pre>
<p><code>2021-11-02-180445-the-art-spirit.md</code></p>
<pre><code class="language-markdown"># [[Robert Henri - The Art Spirit.md]]

Of course it is not easy to go one’s road. Because of our education we
continually get off our track, but the fight is a good one and there is joy in
it if there is any success at all. After all, the goal is not making art. It is
living a life. Those who live their lives will leave the stuff that is really
art. Art is a result. It is the trace of those who have led their lives. It is
interesting to us because we read the struggle and the degree of success the
man made in his struggle to live. The great question is: “What is worth while?”
The majority of people have failed to ask themselves seriously enough, and have
failed to try seriously enough to answer this question.
</code></pre>
<p><code>2021-11-02-181250-the-art-spirit.md</code></p>
<pre><code class="language-markdown"># [[Robert Henri - The Art Spirit.md]]

We are not here to do what has already been done.
</code></pre>
<p><code>2021-11-02-181325-the-art-spirit.md</code></p>
<pre><code class="language-markdown"># [[Robert Henri - The Art Spirit.md]]

The object of painting a picture is not to make a picture—however unreasonable
this may sound. The picture, if a picture results, is a by-product and may be
useful, valuable, interesting as a sign of what has past. The object, which is
back of every true work of art, is the attainment of a state of being, a state
of high functioning, a more than ordinary moment of existence. In such moments
activity is inevitable, and whether this activity is with brush, pen, chisel,
or tongue, its result is but a by-product of the state, a trace, the footprint
of the state.

tags: #artist #being
</code></pre>
<p><code>2021-11-02-181510-the-art-spirit.m</code></p>
<pre><code class="language-markdown"># [[Robert Henri - The Art Spirit.md]]

Do not let the fact that things are not made for you, that conditions are not
as they should be, stop you. Go on anyway. Everything depends on those who go
on anyway.

tags: #inspiration
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="string-sanitization"><a class="header" href="#string-sanitization">String Sanitization</a></h1>
<p>To avoid any unexpected behavior, certain user-provided strings are sanitized
before they are used for naming files or directories. Characters are either
removed or replaced with an underscore <code>_</code>.</p>
<div class="table-wrapper"><table><thead><tr><th>Character</th><th style="text-align: center">Removed</th><th style="text-align: center">Replaced</th></tr></thead><tbody>
<tr><td><code>\n</code></td><td style="text-align: center"><i class="fa fa-check"></i></td><td style="text-align: center"></td></tr>
<tr><td><code>\r</code></td><td style="text-align: center"><i class="fa fa-check"></i></td><td style="text-align: center"></td></tr>
<tr><td><code>\0</code></td><td style="text-align: center"><i class="fa fa-check"></i></td><td style="text-align: center"></td></tr>
<tr><td><code>:</code></td><td style="text-align: center"></td><td style="text-align: center"><i class="fa fa-check"></i></td></tr>
<tr><td><code>/</code></td><td style="text-align: center"></td><td style="text-align: center"><i class="fa fa-check"></i></td></tr>
</tbody></table>
</div>
<p>This following values are sanitized:</p>
<ul>
<li><a href="templates//templates/configuration/template-groups.html">Template Group</a> set in the <code>group</code> config key.</li>
<li>The rendered values from <a href="templates//templates/configuration/names.html">Names</a> set in the <code>names</code> config key.</li>
</ul>
<!-- TODO: Provde some examples. -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="context-reference"><a class="header" href="#context-reference">Context Reference</a></h1>
<p>Every template is injected with a "context" i.e. the data currently available to rendering. ReadStor
injects three different objects into every template context: <code>book</code>, <code>annotation</code> (or <code>annotations</code>
depending on the <a href="templates/context-reference//templates/configuration/context-modes.html">Context Mode</a>) and <code>names</code>.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td><code>book</code></td><td>The current <a href="templates/context-reference//templates/context-reference/book.html">Book</a> being rendered.</td></tr>
<tr><td><code>annotation</code></td><td>A single <a href="templates/context-reference//templates/context-reference/annotation.html">Annotation</a> belonging to the current book.</td></tr>
<tr><td><code>annotations</code></td><td>Multiple <a href="templates/context-reference//templates/context-reference/annotation.html">Annotations</a> belonging to the current book.</td></tr>
<tr><td><code>names</code></td><td>A set of <a href="templates/context-reference//templates/context-reference/names.html">Names</a> for generating backlinks between files.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="book"><a class="header" href="#book">Book</a></h1>
<p>A single <code>book</code> object is injected into all template contexts regardless of the template's <a href="templates/context-reference//templates/configuration/context-modes.html">Context
Mode</a>.</p>
<h2 id="template-fields---book"><a class="header" href="#template-fields---book">Template Fields - Book</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Attribute</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>book</code></td><td>dictionary</td><td>book object</td></tr>
<tr><td><code>book.title</code></td><td>string</td><td>title</td></tr>
<tr><td><code>book.author</code></td><td>string</td><td>author</td></tr>
<tr><td><code>book.metadata</code></td><td>dictionary</td><td>metadata</td></tr>
<tr><td><code>book.metadata.id</code></td><td>string</td><td>unique id</td></tr>
<tr><td><code>book.metadata.last_opened</code></td><td>datetime</td><td>date last opened</td></tr>
<tr><td><code>book.slugs</code></td><td>dictionary</td><td>slugs object</td></tr>
<tr><td><code>book.slugs.title</code></td><td>string</td><td>title slugified</td></tr>
<tr><td><code>book.slugs.author</code></td><td>string</td><td>author slugified</td></tr>
<tr><td><code>book.slugs.metadata</code></td><td>datetime</td><td>slugs metadata object</td></tr>
<tr><td><code>book.slugs.metadata.last_opened</code></td><td>datetime</td><td>date last opened slugified</td></tr>
</tbody></table>
</div>
<h2 id="example-data---book"><a class="header" href="#example-data---book">Example Data - Book</a></h2>
<pre><code class="language-json">{
  "title": "The Art Spirit",
  "author": "Robert Henri",
  "tags": ["#artist", "#being", "#inspiration"],
  "metadata": {
    "id": "1969AF0ECA8AE4965029A34316813924",
    "last_opened": "2021-11-02T18:27:04.781938076Z"
  },
  "slugs": {
    "title": "the-art-spirit",
    "author": "robert-henri"
  }
}
</code></pre>
<h2 id="example-template---book"><a class="header" href="#example-template---book">Example Template - Book</a></h2>
<pre><code class="language-jinja2">---
title: {{ book.title }}
author: {{ book.author }}
id: {{ book.metadata.id }}
last-opened: {{ book.metadata.last_opened | date(format="%Y-%m-%d-%H:%M") }}
---
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> Here <a href="https://tera.netlify.app/">Tera</a>'s <a href="https://tera.netlify.app/docs/#date"><code>date</code></a> filter is used to format
a <code>datetime</code> object into a human-readable date.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="annotation"><a class="header" href="#annotation">Annotation</a></h1>
<p>The number of <code>annotation</code> objects injected into a template depends on the template's
<a href="templates/context-reference//templates/configuration/context-modes.html">Context Mode</a>. When the <a href="templates/context-reference//templates/configuration/context-modes.html#the-annotation-context">Context Mode</a> is set to
<code>annotation</code>, a single <code>annotation</code> object is injected into the template's context. When the
<a href="templates/context-reference//templates/configuration/context-modes.html#the-book-context">Context Mode</a> is set to <code>book</code>, multiple <code>annotation</code> objects, under the name
<code>annotations</code>, are injected into the template's context.</p>
<h2 id="template-fields---annotation"><a class="header" href="#template-fields---annotation">Template Fields - Annotation</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Attribute</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>annotations</code></td><td>list[dictionary]</td><td>annotation objects</td></tr>
<tr><td><code>annotation</code></td><td>dictionary</td><td>annotation object</td></tr>
<tr><td><code>annotation.body</code></td><td>string</td><td>body</td></tr>
<tr><td><code>annotation.style</code></td><td>string</td><td>highlight style/color</td></tr>
<tr><td><code>annotation.notes</code></td><td>string</td><td>notes</td></tr>
<tr><td><code>annotation.tags</code></td><td>list[string]</td><td>tags</td></tr>
<tr><td><code>annotation.metadata</code></td><td>dictionary</td><td>metadata</td></tr>
<tr><td><code>annotation.metadata.id</code></td><td>string</td><td>unique id</td></tr>
<tr><td><code>annotation.metadata.book_id</code></td><td>string</td><td>book's unique id</td></tr>
<tr><td><code>annotation.metadata.created</code></td><td>datetime</td><td>date created</td></tr>
<tr><td><code>annotation.metadata.modified</code></td><td>datetime</td><td>date modified</td></tr>
<tr><td><code>annotation.metadata.location</code></td><td>string</td><td>location string</td></tr>
<tr><td><code>annotation.metadata.epubcfi</code></td><td>string</td><td><a href="https://w3c.github.io/epub-specs/epub33/epubcfi/">epubcfi</a></td></tr>
<tr><td><code>annotation.slugs</code></td><td>dictionary</td><td>slugs object</td></tr>
<tr><td><code>annotation.slugs.metadata</code></td><td>dictionary</td><td>slugs metadata object</td></tr>
<tr><td><code>annotation.slugs.metadata.created</code></td><td>string</td><td>date created slugified</td></tr>
<tr><td><code>annotation.slugs.metadata.modified</code></td><td>string</td><td>date modified slugified</td></tr>
</tbody></table>
</div>
<h2 id="example-data---annotation"><a class="header" href="#example-data---annotation">Example Data - Annotation</a></h2>
<pre><code class="language-json">{
  "body": "Of course it is not easy to go one’s road...",
  "style": "blue",
  "notes": "",
  "tags": [],
  "metadata": {
    "id": "9D1B71B1-895C-446F-A03F-50C01146F532",
    "book_id": "1969AF0ECA8AE4965029A34316813924",
    "created": "2021-11-02T18:04:45.184863090Z",
    "modified": "2021-11-02T18:12:30.355533123Z",
    "location": "6.26.4.2.446.2.1:0",
    "epubcfi": "epubcfi(/6/26[Part09_Split4]!/4/2/446/2/1,:0,:679)",
    "slugs": {
      "created": "2021-11-02-180445",
      "modified": "2021-11-02-180445"
    }
  }
}
</code></pre>
<h2 id="example-template---annotation"><a class="header" href="#example-template---annotation">Example Template - Annotation</a></h2>
<pre><code class="language-jinja2">{% for annotation in annotations -%}

---

{{ annotation.body }}

{%- if annotation.notes %}notes: {{ annotation.notes }}{% endif -%}
{%- if annotation.tags %}tags: {{ annotation.tags | join(sep=" ") }}{% endif %}

{% endfor %}
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> Here <a href="https://tera.netlify.app/">Tera</a>'s <a href="https://tera.netlify.app/docs/#join"><code>join</code></a> filter is used to join
an array of items into a space-separated string.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="names-1"><a class="header" href="#names-1">Names</a></h1>
<p>A single <code>names</code> object is injected into all template contexts regardless of the template's
<a href="templates/context-reference//templates/configuration/context-modes.html">Context Mode</a>. These contain all the file and directory names rendered from the
<code>names</code> key in the template's config. See <a href="templates/context-reference//templates/configuration/names.html">Names</a> for more information.</p>
<h2 id="template-fields---names"><a class="header" href="#template-fields---names">Template Fields - Names</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Attribute</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>names</code></td><td>dictionary</td><td>names object</td></tr>
<tr><td><code>names.book</code></td><td>string</td><td>rendered book filename</td></tr>
<tr><td><code>names.annotations</code></td><td>list[dictionary]</td><td>annotation names</td></tr>
<tr><td><code>names.directory</code></td><td>string</td><td>rendered directory name</td></tr>
</tbody></table>
</div>
<p>The <code>names.annotations</code> object is a list of dictionaries, where each dictionary refers to a rendered
annotation file and contains its filename along with metadata about its respective annotation. Each
dictionary consists of the following attributes:</p>
<div class="table-wrapper"><table><thead><tr><th>Attribute</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>filename</code></td><td>string</td><td>rendered annotation filename</td></tr>
<tr><td><code>created</code></td><td>datetime</td><td>date created</td></tr>
<tr><td><code>modified</code></td><td>datetime</td><td>date modified</td></tr>
<tr><td><code>location</code></td><td>string</td><td>location string</td></tr>
</tbody></table>
</div>
<p>These attributes allow the sorting of the <code>names.annotations</code> list using <a href="https://tera.netlify.app/">Tera</a>'s
<a href="https://tera.netlify.app/docs/#sort"><code>sort</code></a> filter. See <a href="templates/context-reference//templates/backlinks.html">Backlinks</a> for example usage.</p>
<h2 id="example-data---names"><a class="header" href="#example-data---names">Example Data - Names</a></h2>
<p>With the following <code>names</code> configuration:</p>
<pre><code class="language-yaml">names:
  book: "{{ book.author }} - {{ book.title }}"
  annotation: "{{ annotation.slugs.metadata.created }}-{{ book.slugs.title }}"
  directory: "{{ book.author }} - {{ book.title }}"
</code></pre>
<pre><code class="language-json">{
  "book": "Robert Henri - The Art Spirit.md",
  "annotations": [
    {
      "filename": "2021-11-02-181510-the-art-spirit.md",
      "created": "2021-11-02T18:15:10.700510978Z",
      "modified": "2021-11-02T18:15:20.879488945Z",
      "location": "6.26.4.2.636.2.1:0"
    },
    {
      "filename": "2021-11-02-180445-the-art-spirit.md",
      "created": "2021-11-02T18:04:45.184863090Z",
      "modified": "2021-11-02T18:12:30.355533123Z",
      "location": "6.26.4.2.446.2.1:0"
    },
    {
      "filename": "2021-11-02-181325-the-art-spirit.md",
      "created": "2021-11-02T18:13:25.905355930Z",
      "modified": "2021-11-02T18:14:12.444134950Z",
      "location": "6.24.4.2.296.2.1:0"
    },
    {
      "filename": "2021-11-02-181250-the-art-spirit.md",
      "created": "2021-11-02T18:12:50.826642036Z",
      "modified": "2021-11-02T18:12:51.831905841Z",
      "location": "6.18.4.2.20.2.1:0"
    }
  ],
  "directory": "Robert Henri - The Art Spirit"
}
</code></pre>
<h2 id="example-template---names"><a class="header" href="#example-template---names">Example Template - Names</a></h2>
<pre><code class="language-jinja2"># {{ book.author }} - {{ book.title }}

{% for name in names.annotations | sort(attribute="location") -%}
![[{{ name.filename }}]]
{% endfor %}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="apple-books"><a class="header" href="#apple-books">Apple Books</a></h1>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> The following section assumes that Apple Books syncing
with iCloud Drive is disabled!</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="macos"><a class="header" href="#macos">macOS</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="macos---library-location"><a class="header" href="#macos---library-location">macOS - Library Location</a></h1>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> The following information assumes that Apple Books
syncing with iCloud Drive is disabled!</p>
</blockquote>
<p>Apple Books for macOS stores its data in two directories within <code>~/Library/Containers/</code>.</p>
<h2 id="assets"><a class="header" href="#assets">Assets</a></h2>
<p>EPUBs, PDFs, Audiobooks, etc. are stored in:</p>
<pre><code class="language-plaintext">~/Library/Containers/com.apple.BKAgentService
</code></pre>
<h2 id="databases"><a class="header" href="#databases">Databases</a></h2>
<p>The books and annotations databases are stored in:</p>
<pre><code class="language-plaintext">~/Library/Containers/com.apple.iBooksX
</code></pre>
<p>The books database is located at:</p>
<pre><code class="language-plaintext">~/Library/Containers/com.apple.iBooksX/Data/Documents/BKLibrary/BKLibrary***.sqlite
</code></pre>
<p>The annotations database is located at:</p>
<pre><code class="language-plaintext">~/Library/Containers/com.apple.iBooksX/Data/Documents/AEAnnotation/AEAnnotation***.sqlite
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> Note that the database names will vary therefore <code>***</code> is used
in the filenames here.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="macos---archiverestore-library"><a class="header" href="#macos---archiverestore-library">macOS - Archive/Restore Library</a></h1>
<blockquote>
<p><i class="fa fa-info-circle"></i> Complete archive and restore scripts are available in
<a href="https://github.com/tnahs/readstor/tree/main/scripts/apple-books/">scripts/apple-books</a>.</p>
</blockquote>
<!-- TODO: Add a paragraph on what the goal of archiving is. -->
<h2 id="what-to-archiverestore"><a class="header" href="#what-to-archiverestore">What To Archive/Restore?</a></h2>
<p>Apple Books for macOS stores its data in two locations:</p>
<pre><code class="language-plaintext">~/Library/Containers/com.apple.BKAgentService
~/Library/Containers/com.apple.iBooksX
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="apple-books/macos//apple-books/macos/library-location.html">macOS - Library Location</a> for more
information.</p>
</blockquote>
<p>However, archiving and restoring only these directories might miss some metadata. Searching
<code>~/Library/Containers</code> for anything that contains <code>Books</code> yields some other directories:</p>
<pre><code class="language-bash">find ~/Library/Containers -type d -name "*Books*"

./com.apple.BKAgentService/Data/Documents/iBooks
./com.apple.BKAgentService/Data/Documents/iBooks/Books
./com.apple.iBooksX
./com.apple.iBooksX/Data/Documents/BCCloudKit-iBooks
./com.apple.iBooksX/Data/Documents/BCCloudAsset-iBooks
./com.apple.iBooksX/Data/Documents/BKBookstore
./com.apple.iBooksX/Data/Library/Caches/com.apple.iBooksX
./com.apple.iBooksX.CacheDelete
./com.apple.iBooksX.DiskSpaceEfficiency
./com.apple.iBooksX.SharingExtension
./com.apple.iBooksX-SecureUserDefaults
</code></pre>
<p>Using <code>BK</code> as a proxy for <code>Books</code> yields no additional directories:</p>
<pre><code class="language-bash">find ~/Library/Containers -type d -name "*BK*"

./com.apple.BKAgentService
./com.apple.iBooksX/Data/Documents/BKSeriesDatabase
./com.apple.iBooksX/Data/Documents/BKLibraryDataSourceDevelopment
./com.apple.iBooksX/Data/Documents/BKLibrary
./com.apple.iBooksX/Data/Documents/BKBookstore
</code></pre>
<p>So it's safe to assume any directory starting with <code>com.apple.Books</code> or <code>com.apple.BK</code> is important.
Therefore, these two globs along with Apple Books' <code>Group Container</code> should be used for archiving
and restoring:</p>
<pre><code class="language-plaintext">~/Library/Containers/com.apple.BK*
~/Library/Containers/com.apple.iBooks*
~/Library/Group\ Containers/group.com.apple.iBooks
</code></pre>
<h2 id="important-note"><a class="header" href="#important-note"><i class="fa fa-exclamation-circle"></i> Important Note</a></h2>
<p>Archiving/restoring will work <strong>only</strong> if the path to the username <strong>has not changed</strong> since the
library was archived. Doing a few searches shows that the username has been hard-coded into some
files. This is most evident in the <code>BKLibrary-*.sqlite</code> file which contains absolute paths to
library files.</p>
<p>For example:</p>
<pre><code class="language-bash">find ~/Library/Containers/com.apple.BKAgentService \
    -type f -a -exec grep -l --exclude=\*.{htm,html,xhtml} $USER {} +

.../.com.apple.containermanagerd.metadata.plist
.../Container.plist
.../Data/Documents/iBooks/Books/Books.plist
</code></pre>
<pre><code class="language-bash">find ~/Library/Containers/com.apple.iBooksX* \
    -type f -a -exec grep -l --exclude=\*.{htm,html,xhtml} $USER {} +

.../com.apple.iBooksX/.com.apple.containermanagerd.metadata.plist
.../com.apple.iBooksX/Container.plist
.../com.apple.iBooksX/Data/Documents/BKLibrary/BKLibrary-1-091020131601.sqlite-wal
.../com.apple.iBooksX/Data/Documents/BKLibrary/BKLibrary-1-091020131601.sqlite
.../com.apple.iBooksX-SecureUserDefaults/.com.apple.containermanagerd.metadata.plist
.../com.apple.iBooksX-SecureUserDefaults/Container.plist
.../com.apple.iBooksX.CacheDelete/.com.apple.containermanagerd.metadata.plist
.../com.apple.iBooksX.CacheDelete/Container.plist
.../com.apple.iBooksX.DiskSpaceEfficiency/.com.apple.containermanagerd.metadata.plist
.../com.apple.iBooksX.DiskSpaceEfficiency/Container.plist
.../com.apple.iBooksX.SharingExtension/.com.apple.containermanagerd.metadata.plist
.../com.apple.iBooksX.SharingExtension/Container.plist
</code></pre>
<h2 id="archive-library"><a class="header" href="#archive-library">Archive Library</a></h2>
<blockquote>
<p><i class="fa fa-info-circle"></i> The following snippet is taken from
<a href="https://github.com/tnahs/readstor/tree/main/scripts/apple-books/macos-archive.sh">scripts/apple-books/macos-archive.sh</a>.</p>
</blockquote>
<p>Archiving the library is as simple as running two <code>rsync</code> commands. This should save all the
relevant Apple Books data and metadata to a single directory. Make sure to replace
<code>[PATH-TO-ARCHIVE]</code> with a valid path to said directory.</p>
<pre><code class="language-bash">rsync \
    --archive \
    --extended-attributes \
    $HOME/Library/Containers/com.apple.BK* \
    $HOME/Library/Containers/com.apple.iBooks* \
    [PATH-TO-ARCHIVE]/Containers

rsync \
    --archive \
    --extended-attributes \
    $HOME/Library/Group\ Containers/group.com.apple.iBooks \
    [PATH-TO-ARCHIVE]/Group\ Containers
</code></pre>
<p>For example, if <code>[PATH-TO-ARCHIVE]</code> is:</p>
<pre><code class="language-plaintext">~/archives/2022-10-08--apple-books-v4.4-5177--macos-v12.6
</code></pre>
<p>Our <code>rsync</code> commands would be:</p>
<pre><code class="language-bash">rsync \
    --archive \
    --extended-attributes \
    $HOME/Library/Containers/com.apple.BK* \
    $HOME/Library/Containers/com.apple.iBooks* \
    ~/archives/2022-10-08--apple-books-v4.4-5177--macos-v12.6/Containers

rsync \
    --archive \
    --extended-attributes \
    $HOME/Library/Group\ Containers/group.com.apple.iBooks \
    ~/archives/2022-10-08--apple-books-v4.4-5177--macos-v12.6/Group\ Containers
</code></pre>
<p>And the resulting archive would resemble:</p>
<pre><code class="language-plaintext">~/archives
  └── 2022-10-08--apple-books-v4.4-5177--macos-v12.6
      ├── Containers
      │   ├── com.apple.BKAgentService
      │   ├── com.apple.iBooks.BooksNotificationContentExtension
      │   ├── com.apple.iBooks.engagementExtension
      │   ├── com.apple.iBooks.iBooksSpotlightExtension
      │   ├── com.apple.iBooksX
      │   ├── com.apple.iBooksX-SecureUserDefaults
      │   ├── com.apple.iBooksX.BooksThumbnail
      │   ├── com.apple.iBooksX.CacheDelete
      │   ├── com.apple.iBooksX.DiskSpaceEfficiency
      │   └── com.apple.iBooksX.SharingExtension
      └── Group Containers
          └── group.com.apple.iBooks
</code></pre>
<h1 id="restore-library"><a class="header" href="#restore-library">Restore Library</a></h1>
<blockquote>
<p><i class="fa fa-info-circle"></i> The following snippets are taken from
<a href="https://github.com/tnahs/readstor/tree/main/scripts/apple-books/macos-restore.sh">scripts/apple-books/macos-restore.sh</a>.</p>
</blockquote>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> When restoring a library make sure that the current
version of Apple Books for macOS and the version the archive was created from are identical. Not
doing so could lead to unexpected results.</p>
</blockquote>
<p>Restoring the library takes an extra step. First we need to clear out the current Apple Books
library. We can delete all the library files and directories by using the paths we determined from
<a href="apple-books/macos/archive-restore-library.html#what-to-archiverestore">What To Archive/Restore?</a>.</p>
<pre><code class="language-bash">rm -rf $HOME/Library/Containers/com.apple.BK*
rm -rf $HOME/Library/Containers/com.apple.iBooks*
rm -rf $HOME/Library/Group\ Containers/group.com.apple.iBooks
</code></pre>
<p>Finally, we can run the reverse <code>rsync</code> commands and restore the archive we previously made. Make
sure to replace <code>[PATH-TO-ARCHIVE]</code> with a valid path.</p>
<pre><code class="language-bash">rsync \
    --archive \
    --extended-attributes \
    [PATH-TO-ARCHIVE]/Containers/ \
    $HOME/Library/Containers/

rsync \
    --archive \
    --extended-attributes \
    [PATH-TO-ARCHIVE]/Group\ Containers/ \
    $HOME/Library/Group\ Containers/
</code></pre>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> The trailing forward-slash after <code>Containers</code> and
<code>Group\Containers</code> here is important. It tells <code>rsync</code> to move the archive directory's <em>contents</em>
into the target. Otherwise, it would move the archive <em>directory</em> into the target.</p>
</blockquote>
<p>For example, if <code>[PATH-TO-ARCHIVE]</code> is:</p>
<pre><code class="language-plaintext">~/archives/2022-10-08--apple-books-v4.4-5177--macos-v12.6
</code></pre>
<p>Our <code>rsync</code> command would be:</p>
<pre><code class="language-bash">rsync \
    --archive \
    --extended-attributes \
    ~/archives/2022-10-08--apple-books-v4.4-5177--macos-v12.6/Containers/ \
    $HOME/Library/Containers/  # Note the forward-slash! ---------------^

rsync \
    --archive \
    --extended-attributes \
    ~/archives/2022-10-08--apple-books-v4.4-5177--macos-v12.6/Group\ Containers/ \
    $HOME/Library/Group\ Containers/  # Note the forward-slash! ---------------^
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ios"><a class="header" href="#ios">iOS</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ios---library-location"><a class="header" href="#ios---library-location">iOS - Library Location</a></h1>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> The following information assumes that Apple Books
syncing with iCloud Drive is disabled!</p>
</blockquote>
<p>Apple Books for iOS stores its data in the <code>Books</code> directory on an iOS device.</p>
<pre><code class="language-plaintext">[ios-device]
 │
 ├── Books
 │   ├── Managed/
 │   ├── MetadataStore/
 │   ├── Purchases/
 │   ├── Sync/
 │   ├── Books.plist ╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌ Books data
 │   ├── com.apple.ibooks-sync.plist ╌╌╌╌╌╌╌╌╌╌ Annotations data
 │   ├── 376FAA7E4CF81729.epub ╌╌╌╌╌╌╌╌╌╌╌╌╌┐
 │   ├── 669FEE1FFBB29D81.epub              ├╌╌ EPUBs
 │   ├── F788455723912C6D.epub ╌╌╌╌╌╌╌╌╌╌╌╌╌┘
 │   └── ...
 └── ...
</code></pre>
<p>Both the EPUBs and plists are stored in:</p>
<!-- TODO: Where do PDFs and Audiobooks sit? -->
<pre><code class="language-plaintext">[ios-device]/Books
</code></pre>
<p>The books plist is located at:</p>
<pre><code class="language-plaintext">[ios-device]/Books/Books.plist
</code></pre>
<p>The annotations plist is located at:</p>
<pre><code class="language-plaintext">[ios-device]/Books/com.apple.ibooks-sync.plist
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="apple-books/ios//apple-books/ios/access-library.html">iOS - Access Library</a> for more
information.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ios---access-library"><a class="header" href="#ios---access-library">iOS - Access Library</a></h1>
<p>There are roughly two different methods for accessing iOS's Apple Books library. A (possibly-paid)
third party application or manually mounting the device with <code>macFUSE</code> / <code>ifuse</code>.</p>
<h2 id="access-via-third-party-applications"><a class="header" href="#access-via-third-party-applications">Access via Third-party Applications</a></h2>
<p>There are a number of third-party applications that grant access to an iOS device's filesystem. For
the most part, they all expose the same directories, however, each might differ slightly in how they
are represented in the GUI.</p>
<p>The following is a non-exhaustive list of paid software and the library's location within them:</p>
<h3 id="imazing---httpsimazingcom"><a class="header" href="#imazing---httpsimazingcom">iMazing - <a href="https://imazing.com">https://imazing.com</a></a></h3>
<p><img src="apple-books/ios//images/imazing.png" alt="iMazing Seenshot" /></p>
<h3 id="iexplorer---httpsmacroplantcomiexplorer"><a class="header" href="#iexplorer---httpsmacroplantcomiexplorer">iExplorer - <a href="https://macroplant.com/iexplorer">https://macroplant.com/iexplorer</a></a></h3>
<p><img src="apple-books/ios//images/iexplorer.png" alt="iExplorer Screenshot" /></p>
<h2 id="access-via-macfuse--ifuse"><a class="header" href="#access-via-macfuse--ifuse">Access via <code>macFUSE</code> / <code>ifuse</code></a></h2>
<p>The free and open-source option requires a bit of work during installation but is effortless to run
once complete.</p>
<blockquote>
<p><i class="fa fa-info-circle"></i> Note that this has only been tested on Apple Silicon running
macOS Ventura.</p>
</blockquote>
<h3 id="requirements"><a class="header" href="#requirements">Requirements</a></h3>
<ol>
<li>
<p>Install Homebrew. See <a href="https://brew.sh/">here</a> for installation instructions.</p>
</li>
<li>
<p>Install <code>macFUSE</code>. See <a href="https://github.com/macfuse/macfuse/wiki/Getting-Started">here</a> for installation instructions as <code>macFUSE</code> requires
enabling support for third party kernel extensions and will require a restart.</p>
</li>
<li>
<p>Install <code>ifuse</code></p>
<pre><code class="language-bash">brew install gromgit/fuse/ifuse-mac
</code></pre>
<blockquote>
<p><i class="fa fa-info-circle"></i> Running <code>brew install ifuse</code> is broken as of 2023-02-05.</p>
</blockquote>
</li>
</ol>
<h3 id="mount-the-device"><a class="header" href="#mount-the-device">Mount the Device</a></h3>
<p>First we create a mount point. This can be anywhere and named anything.</p>
<pre><code class="language-bash">mkdir /tmp/my-device
</code></pre>
<h4 id="mount-a-single-device"><a class="header" href="#mount-a-single-device">Mount a Single Device</a></h4>
<p>If only a single device is connected, it can be mounted by simply running:</p>
<pre><code class="language-bash">ifuse /tmp/my-device
</code></pre>
<h4 id="mount-multiple-devices"><a class="header" href="#mount-multiple-devices">Mount Multiple Devices</a></h4>
<p>If there are multiple devices connected, a specific one can be mounted using its serial number.
Assuming the device is an <code>iPhone</code>, run the following command:</p>
<!-- TODO: Verify this works with other devices too. -->
<pre><code class="language-bash">system_profiler SPUSBDataType -detailLevel mini | grep -e iPhone -e Serial
</code></pre>
<p>Something similar to the following will print out. The 24-character string is the device's serial
number.</p>
<pre><code class="language-plaintext">iPhone:
  Serial Number: XXXXXXXXXXXXXXXXXXXXXXXX
  Serial Number: 000000000000
</code></pre>
<p>To convert it to a UDID add a hyphen after the eight character.</p>
<pre><code class="language-plaintext">XXXXXXXX-XXXXXXXXXXXXXXXX
</code></pre>
<p>Finally, to mount the device, pass it to the command after the <code>--udid</code> flag to mount it:</p>
<pre><code class="language-bash">ifuse /tmp/my-device --udid XXXXXXXX-XXXXXXXXXXXXXXXX
</code></pre>
<h3 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h3>
<blockquote>
<p><code>ifuse</code> might complain: <code>Invalid device UDID specified, length needs to be 40 characters</code>.
Starting with the iPhone X, Apple changed <code>UDID</code>s to use 24 bytes &gt; and a dash (<code>-</code>) instead of
the old 40-byte format.</p>
<p>If you get <code>Failed to connect to lockdownd service on the device. Try again. If it still fails try rebooting your device.</code> ensure that your device is connected, and isn't displaying a
"Trust this computer" dialog. You'll need to approve that first. If you then get
<code>ERROR: Device 000000000000000000000000 returned unhandled error code -13</code> you'll need to
disconnect and reconnect the device.</p>
</blockquote>
<p>via <a href="https://reincubate.com/support/how-to/mount-iphone-files/">https://reincubate.com/support/how-to/mount-iphone-files/</a></p>
<h3 id="sources"><a class="header" href="#sources">Sources</a></h3>
<ul>
<li><a href="https://github.com/RhetTbull/osxphotos/issues/745">https://github.com/RhetTbull/osxphotos/issues/745</a></li>
<li><a href="https://reincubate.com/support/how-to/mount-iphone-files/">https://reincubate.com/support/how-to/mount-iphone-files/</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ios---archiverestore-library"><a class="header" href="#ios---archiverestore-library">iOS - Archive/Restore Library</a></h1>
<p>Archiving and restoring iOS's Apple Books library is fairly straightforward. All the relevant data
exists in a single folder. A simple drag/drop, copy/paste or zip/unzip should suffice.</p>
<blockquote>
<p><i class="fa fa-exclamation-circle"></i> When restoring a library make sure that the current
version of iOS and the version the archive was created from are identical. Not doing so could lead
to unexpected results.</p>
</blockquote>
<blockquote>
<p><i class="fa fa-info-circle"></i> See <a href="apple-books/ios//apple-books/ios/library-location.html">iOS - Library Location</a> and
<a href="apple-books/ios//apple-books/ios/access-library.html">iOS - Access Library</a> for more information.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
